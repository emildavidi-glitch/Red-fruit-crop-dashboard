<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sales Intelligence Â· Beverage Market Briefing</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Fira+Code:wght@400;500&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0D1B2A; --navy-mid:#1B2E42; --navy-light:#243B55;
  --accent:#00C9A7; --accent2:#FFB347; --accent3:#FF6B6B;
  --white:#FFFFFF; --offwhite:#F4F7FA; --muted:#8FA3B1;
  --border:#2A3E52; --border-light:#E2EAF0;
  --text:#1A2E3B; --text-mid:#4A6070; --text-light:#8FA3B1;
  --card:#FFFFFF; --card-shadow:0 2px 20px rgba(13,27,42,0.08);
  --green:#00B37E; --red:#E85555; --amber:#F5A623; --blue:#2D9CDB;
  --font-display:'Playfair Display',serif;
  --font-mono:'Fira Code',monospace;
  --font-body:'Lato',sans-serif;
  --tab-h:52px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--offwhite);font-family:var(--font-body);color:var(--text);min-height:100vh;}

.site-header{background:var(--navy);padding:0 40px;height:64px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;border-bottom:2px solid var(--accent);}
.brand{display:flex;align-items:center;gap:14px;}
.brand-dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 12px var(--accent);animation:pulse 2s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.6;transform:scale(1.3);}}
.brand-name{font-family:var(--font-display);font-size:1.2rem;color:var(--white);letter-spacing:.02em;}
.brand-sub{font-family:var(--font-mono);font-size:0.55rem;color:var(--muted);letter-spacing:.15em;text-transform:uppercase;margin-top:2px;}
.header-right{display:flex;align-items:center;gap:20px;}
.header-links{display:flex;gap:8px;}
.header-link{font-family:var(--font-mono);font-size:0.62rem;color:var(--muted);text-decoration:none;padding:5px 12px;border:1px solid var(--border);border-radius:4px;transition:all .2s;}
.header-link:hover{color:var(--accent);border-color:var(--accent);}
#clock{font-family:var(--font-mono);font-size:0.65rem;color:var(--muted);}

/* DATA BAR */
.data-bar{background:var(--navy-mid);padding:8px 40px;display:flex;align-items:center;gap:16px;border-bottom:1px solid var(--border);font-family:var(--font-mono);font-size:0.6rem;flex-wrap:wrap;}
.data-bar .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;}
.data-bar .status-dot.ok{background:var(--green);}
.data-bar .status-dot.warning{background:var(--amber);}
.data-bar .status-dot.error{background:var(--red);}
.data-bar span{color:var(--muted);}
.data-bar .errors-toggle{color:var(--accent3);cursor:pointer;text-decoration:underline;}
.errors-panel{display:none;background:var(--navy);padding:10px 40px;font-family:var(--font-mono);font-size:0.58rem;color:var(--accent3);border-bottom:1px solid var(--border);}
.errors-panel.show{display:block;}

/* TABS */
.region-nav{background:var(--white);border-bottom:2px solid var(--border-light);padding:0 40px;display:flex;align-items:flex-end;gap:0;position:sticky;top:64px;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.region-tab{height:var(--tab-h);padding:0 20px;display:flex;align-items:center;gap:8px;font-family:var(--font-body);font-size:0.82rem;font-weight:700;color:var(--text-mid);cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;white-space:nowrap;user-select:none;}
.region-tab:hover{color:var(--text);border-bottom-color:var(--border-light);}
.region-tab.active{color:var(--navy);border-bottom-color:var(--accent);}
.region-tab .count{background:var(--accent);color:var(--navy);font-family:var(--font-mono);font-size:0.52rem;font-weight:700;padding:1px 5px;border-radius:8px;min-width:18px;text-align:center;}

main{max-width:1440px;margin:0 auto;padding:28px 40px;}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* INSIGHT BOX */
.insight-box{background:linear-gradient(135deg,var(--navy),var(--navy-light));border-radius:10px;padding:18px 20px;color:var(--white);margin-bottom:20px;position:relative;overflow:hidden;}
.insight-box::before{content:'ğŸ“¡';font-size:60px;opacity:.06;position:absolute;right:-5px;top:-5px;}
.insight-label{font-family:var(--font-mono);font-size:0.58rem;text-transform:uppercase;letter-spacing:.12em;color:var(--accent);margin-bottom:6px;}
.insight-text{font-size:0.82rem;line-height:1.6;color:rgba(255,255,255,0.9);}
.insight-source{font-family:var(--font-mono);font-size:0.55rem;color:var(--muted);margin-top:8px;}

/* CARDS GRID */
.global-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;}
.region-card{background:var(--card);border-radius:10px;padding:18px 20px;box-shadow:var(--card-shadow);border:1px solid var(--border-light);cursor:pointer;transition:transform .15s,box-shadow .15s,border-color .15s;}
.region-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.1);border-color:var(--accent);}
.region-card-hd{display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.region-card-flag{font-size:1.5rem;}
.region-card-name{font-family:var(--font-display);font-size:1rem;color:var(--navy);}
.region-card-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.rc-stat{background:var(--offwhite);border-radius:6px;padding:7px 10px;}
.rc-stat-val{font-family:var(--font-mono);font-size:0.9rem;font-weight:500;color:var(--navy);}
.rc-stat-lbl{font-family:var(--font-mono);font-size:0.52rem;text-transform:uppercase;color:var(--text-light);margin-top:2px;}
.region-card-signal{margin-top:10px;padding:6px 10px;border-radius:6px;font-family:var(--font-mono);font-size:0.62rem;background:#E8F5E9;color:#2E7D32;}
.rc-stat-info{cursor:help;font-size:0.58rem;color:var(--accent);margin-left:4px;}

/* PANELS */
.panel{background:var(--card);border-radius:12px;box-shadow:var(--card-shadow);border:1px solid var(--border-light);overflow:hidden;margin-bottom:16px;}
.panel-hd{padding:14px 20px;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,var(--offwhite),var(--white));}
.panel-title{font-family:var(--font-display);font-size:1rem;color:var(--navy);display:flex;align-items:center;gap:8px;}
.panel-badge{font-family:var(--font-mono);font-size:0.55rem;text-transform:uppercase;letter-spacing:.1em;padding:3px 8px;border-radius:12px;}
.badge-launch{background:#E8F5FF;color:#1565C0;}
.badge-trend{background:#E8FFF5;color:#00695C;}
.badge-pricing{background:#FFF8E8;color:#E65100;}
.badge-regulatory{background:#F3E8FF;color:#6A1B9A;}
.badge-competitor{background:#FFF0F0;color:#C62828;}
.badge-supply{background:#E0F2F1;color:#004D40;}
.badge-action{background:#FFF3E0;color:#E65100;}
.panel-body{padding:20px;}

/* NEWS ITEMS */
.news-list{display:flex;flex-direction:column;gap:10px;}
.news-item{padding:12px 14px;border-radius:8px;border:1px solid var(--border-light);transition:transform .15s,box-shadow .15s;cursor:default;}
.news-item:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(0,0,0,0.06);}
.news-meta{display:flex;align-items:center;gap:8px;margin-bottom:5px;flex-wrap:wrap;}
.news-cat{font-family:var(--font-mono);font-size:0.52rem;text-transform:uppercase;letter-spacing:.08em;padding:2px 7px;border-radius:8px;}
.cat-launch{background:#E3F2FD;color:#1565C0;}
.cat-innovation{background:#E8F5E9;color:#2E7D32;}
.cat-trend{background:#E8F5E9;color:#2E7D32;}
.cat-pricing{background:#FFF3E0;color:#E65100;}
.cat-regulatory{background:#F3E8FF;color:#6A1B9A;}
.cat-competitor{background:#FFF0F0;color:#C62828;}
.cat-supply_chain{background:#E0F2F1;color:#004D40;}
.cat-retail{background:#FBE9E7;color:#BF360C;}
.cat-macro{background:#ECEFF1;color:#37474F;}
.news-source{font-family:var(--font-mono);font-size:0.52rem;color:var(--text-light);}
.news-date{font-family:var(--font-mono);font-size:0.52rem;color:var(--text-light);margin-left:auto;}
.news-headline{font-size:0.84rem;font-weight:700;color:var(--text);line-height:1.35;margin-bottom:4px;}
.news-summary{font-size:0.72rem;color:var(--text-mid);line-height:1.5;}
.news-why{font-size:0.68rem;color:var(--navy);background:var(--offwhite);padding:6px 10px;border-radius:6px;margin-top:6px;border-left:3px solid var(--accent);}
.news-link{font-family:var(--font-mono);font-size:0.6rem;color:var(--accent);text-decoration:none;margin-top:5px;display:inline-block;}
.news-conf{font-family:var(--font-mono);font-size:0.48rem;padding:2px 6px;border-radius:6px;margin-left:6px;}
.conf-high{background:#E8F5E9;color:#2E7D32;}
.conf-medium{background:#FFF8E1;color:#F57F17;}
.conf-low{background:#FFEBEE;color:#C62828;}
.news-tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;}
.news-tag{font-family:var(--font-mono);font-size:0.48rem;background:var(--offwhite);color:var(--text-mid);padding:1px 6px;border-radius:6px;}

/* FILTERS */
.filter-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px;}
.cat-filters{display:flex;gap:6px;flex-wrap:wrap;}
.cat-btn{font-family:var(--font-mono);font-size:0.6rem;text-transform:uppercase;letter-spacing:.06em;padding:5px 12px;border-radius:20px;border:1px solid var(--border-light);background:var(--white);cursor:pointer;transition:all .15s;color:var(--text-mid);}
.cat-btn:hover{border-color:var(--accent);color:var(--accent);}
.cat-btn.active{background:var(--navy);color:var(--white);border-color:var(--navy);}

/* BRIEFING SECTIONS */
.briefing-section{margin-bottom:16px;}
.briefing-item{padding:10px 14px;border-radius:8px;border:1px solid var(--border-light);margin-bottom:8px;}
.briefing-item:last-child{margin-bottom:0;}
.bi-headline{font-size:0.82rem;font-weight:700;color:var(--text);margin-bottom:4px;}
.bi-detail{font-size:0.72rem;color:var(--text-mid);line-height:1.5;}
.bi-meta{font-family:var(--font-mono);font-size:0.52rem;color:var(--text-light);margin-top:4px;}
.bi-link{font-family:var(--font-mono);font-size:0.55rem;color:var(--accent);text-decoration:none;}

/* COPY BTN */
.copy-btn{font-family:var(--font-mono);font-size:0.6rem;padding:6px 14px;border-radius:6px;border:1px solid var(--border-light);background:var(--white);cursor:pointer;color:var(--text-mid);transition:all .15s;}
.copy-btn:hover{border-color:var(--accent);color:var(--accent);}

/* POPOVER */
.info-popover{position:relative;display:inline-block;}
.info-popover .pop-content{display:none;position:absolute;bottom:120%;left:50%;transform:translateX(-50%);background:var(--navy);color:var(--white);padding:10px 14px;border-radius:8px;font-family:var(--font-mono);font-size:0.55rem;line-height:1.5;width:280px;z-index:300;box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.info-popover:hover .pop-content{display:block;}

/* INTEL GRID */
.intel-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}

/* LOADING / EMPTY */
.loading{display:flex;align-items:center;gap:8px;padding:24px;color:var(--text-light);font-family:var(--font-mono);font-size:0.72rem;}
.spinner{width:14px;height:14px;border:2px solid var(--border-light);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

footer{background:var(--navy);color:var(--muted);padding:16px 40px;font-family:var(--font-mono);font-size:0.6rem;display:flex;justify-content:space-between;margin-top:32px;flex-wrap:wrap;gap:8px;}

@media(max-width:1024px){
  main,.site-header,.data-bar,.region-nav,footer{padding-left:16px;padding-right:16px;}
  .intel-grid{grid-template-columns:1fr;}
  .global-grid{grid-template-columns:1fr 1fr;}
}
@media(max-width:640px){
  .global-grid{grid-template-columns:1fr;}
  .region-nav{overflow-x:auto;}
}
</style>
</head>
<body>

<header class="site-header">
  <div class="brand">
    <div class="brand-dot"></div>
    <div>
      <div class="brand-name">Sales Intelligence</div>
      <div class="brand-sub">Beverage Market Briefing Â· Global</div>
    </div>
  </div>
  <div class="header-right">
    <div class="header-links">
      <a href="index.html" class="header-link">ğŸ’ Red Fruit DSS</a>
      <a href="oj.html" class="header-link">ğŸŠ OJ Monitor</a>
    </div>
    <span id="clock"></span>
  </div>
</header>

<!-- DATA STATUS BAR -->
<div class="data-bar" id="data-bar">
  <span class="status-dot" id="status-dot"></span>
  <span id="data-status">Loading pipeline dataâ€¦</span>
  <span class="errors-toggle" id="errors-toggle" style="display:none;" onclick="document.getElementById('errors-panel').classList.toggle('show')">Show details</span>
</div>
<div class="errors-panel" id="errors-panel"></div>

<!-- REGION TABS -->
<nav class="region-nav" id="region-nav"></nav>

<main>
  <!-- Panels injected by JS -->
  <div id="panel-global" class="tab-panel active"></div>
  <div id="panel-usa" class="tab-panel"></div>
  <div id="panel-germany" class="tab-panel"></div>
  <div id="panel-france" class="tab-panel"></div>
  <div id="panel-spain" class="tab-panel"></div>
  <div id="panel-italy" class="tab-panel"></div>
  <div id="panel-austria" class="tab-panel"></div>
</main>

<footer>
  <div>ğŸ“Š Sales Intelligence Â· Beverage Market Â· Auto-updated daily via GitHub Actions</div>
  <div>Sources: FoodNavigator Â· BeverageDaily Â· Just-Drinks Â· Google News RSS Â· FDA Â· EFSA Â· Open data only</div>
</footer>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DATA = { news: null, briefings: null, stats: null, health: null };

const REGION_META = {
  usa:     { name:'United States', flag:'ğŸ‡ºğŸ‡¸' },
  germany: { name:'Germany',       flag:'ğŸ‡©ğŸ‡ª' },
  france:  { name:'France',        flag:'ğŸ‡«ğŸ‡·' },
  spain:   { name:'Spain',         flag:'ğŸ‡ªğŸ‡¸' },
  italy:   { name:'Italy',         flag:'ğŸ‡®ğŸ‡¹' },
  austria: { name:'Austria',       flag:'ğŸ‡¦ğŸ‡¹' },
};

const CAT_LABELS = {
  all:'All', launch:'Launches', innovation:'Innovation', regulatory:'Regulatory',
  pricing:'Pricing', competitor:'Competitor', supply_chain:'Supply Chain',
  retail:'Retail', trend:'Trends', macro:'Macro',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadJSON(file) {
  try {
    const r = await fetch(file + '?_=' + Date.now(), { signal: AbortSignal.timeout(8000) });
    if (!r.ok) throw new Error(`${r.status}`);
    return await r.json();
  } catch(e) { console.warn(`Failed: ${file}`, e); return null; }
}

async function loadAllData() {
  [DATA.news, DATA.briefings, DATA.stats, DATA.health] = await Promise.all([
    loadJSON('sales_news.json'),
    loadJSON('sales_briefings.json'),
    loadJSON('market_stats.json'),
    loadJSON('data_health.json'),
  ]);
  renderDataBar();
  renderTabs();
  renderGlobal();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STATUS BAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDataBar() {
  const dot = document.getElementById('status-dot');
  const status = document.getElementById('data-status');
  const toggle = document.getElementById('errors-toggle');
  const errPanel = document.getElementById('errors-panel');

  if (!DATA.health) {
    dot.className = 'status-dot error';
    status.textContent = 'Pipeline data not available â€” run GitHub Actions workflow';
    return;
  }

  const h = DATA.health;
  const genAt = new Date(h.generated_at);
  const ageH = ((Date.now() - genAt.getTime()) / 3600000).toFixed(1);
  const allOk = Object.values(h.regions).every(r => r.status === 'ok');
  const hasErr = Object.values(h.regions).some(r => r.status === 'error');

  dot.className = `status-dot ${hasErr ? 'error' : allOk ? 'ok' : 'warning'}`;
  status.textContent = `Data updated: ${genAt.toLocaleString()} (${ageH}h ago) Â· Window: ${DATA.news?.window_days || 28} days Â· Items: ${h.global.total_items} Â· Sources: ${h.global.total_sources_ok} OK / ${h.global.total_sources_failed} failed`;

  // Show errors if any
  const errs = DATA.news?.meta?.errors || [];
  const regionNotes = Object.entries(h.regions).filter(([_,v]) => v.notes.length > 0);
  if (errs.length > 0 || regionNotes.length > 0) {
    toggle.style.display = 'inline';
    let html = '';
    regionNotes.forEach(([rid, v]) => {
      v.notes.forEach(n => { html += `<div>${REGION_META[rid]?.flag||''} ${rid}: ${n}</div>`; });
    });
    errs.slice(0, 10).forEach(e => { html += `<div>âš  ${e.source}: ${e.error.slice(0,80)}</div>`; });
    errPanel.innerHTML = html;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTab = 'global';

function renderTabs() {
  const nav = document.getElementById('region-nav');
  const counts = DATA.news?.meta?.counts || {};
  let html = `<div class="region-tab active" data-region="global" onclick="switchTab('global')">ğŸŒ Global Overview</div>`;
  for (const [rid, meta] of Object.entries(REGION_META)) {
    const cnt = counts[rid] || 0;
    html += `<div class="region-tab" data-region="${rid}" onclick="switchTab('${rid}')">
      <span>${meta.flag}</span> ${meta.name}
      <span class="count" id="cnt-${rid}">${cnt}</span>
    </div>`;
  }
  nav.innerHTML = html;
}

function switchTab(regionId) {
  currentTab = regionId;
  document.querySelectorAll('.region-tab').forEach(t => t.classList.toggle('active', t.dataset.region === regionId));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  const panel = document.getElementById(`panel-${regionId}`);
  panel.classList.add('active');
  if (regionId === 'global') {
    renderGlobal();
  } else if (!panel.dataset.rendered) {
    renderRegion(regionId);
    panel.dataset.rendered = '1';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARKET STAT POPOVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function statPopover(stat) {
  if (!stat) return '';
  const srcs = (stat.sources || []).map(s => `<a href="${s.url}" target="_blank" style="color:var(--accent);">${s.name}</a>`).join(', ');
  return `<span class="info-popover"><span class="rc-stat-info" title="Click for details">â„¹ï¸</span>
    <span class="pop-content">
      Method: ${stat.method || '?'}<br>
      Year: ${stat.year || '?'}<br>
      Sources: ${srcs || 'n/a'}<br>
      Verified: ${stat.last_verified || '?'}<br>
      Confidence: ${stat.confidence || '?'}<br>
      ${stat.notes || ''}
    </span></span>`;
}

function formatMarketSize(stat) {
  if (!stat) return 'â€”';
  const sym = stat.unit === 'USD_B' ? '$' : 'â‚¬';
  return `~${sym}${stat.value}B`;
}

function formatGrowth(stat) {
  if (!stat) return 'â€”';
  return `~+${stat.value}%`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEWS ITEM HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function newsHtml(n) {
  const catCls = `cat-${n.category || 'trend'}`;
  const confCls = `conf-${n.confidence || 'medium'}`;
  const date = n.published ? new Date(n.published).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}) : '';
  const tags = (n.product_tags || []).map(t => `<span class="news-tag">${t}</span>`).join('');
  return `<div class="news-item" data-cat="${n.category}">
    <div class="news-meta">
      <span class="news-cat ${catCls}">${n.category || 'news'}</span>
      <span class="news-conf ${confCls}">${n.confidence || ''}</span>
      <span class="news-source">${n.source || ''}</span>
      <span class="news-date">${date}</span>
    </div>
    <div class="news-headline">${n.title || ''}</div>
    <div class="news-summary">${n.summary || ''}</div>
    ${n.why_it_matters ? `<div class="news-why">ğŸ’¡ ${n.why_it_matters}</div>` : ''}
    ${tags ? `<div class="news-tags">${tags}</div>` : ''}
    ${n.url ? `<a href="${n.url}" target="_blank" rel="noopener" class="news-link">Read more â†’</a>` : ''}
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBAL OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGlobal() {
  const panel = document.getElementById('panel-global');

  // Morning briefing
  const briefingText = DATA.briefings
    ? `Tracked intelligence across ${Object.keys(DATA.briefings.regions).length} regions. ${Object.entries(DATA.briefings.regions).map(([rid, b]) => {
        const s = b.signals?.[0];
        return s ? `${REGION_META[rid]?.name || rid}: ${s.signal.toLowerCase()}` : '';
      }).filter(Boolean).slice(0,3).join('. ')}.`
    : 'Briefing data not yet available â€” run the pipeline.';

  const genAt = DATA.news?.generated_at ? new Date(DATA.news.generated_at).toLocaleString() : 'unknown';

  // Region cards
  let cardsHtml = '';
  for (const [rid, meta] of Object.entries(REGION_META)) {
    const mctx = DATA.stats?.regions?.[rid]?.market_context;
    const ms = mctx?.market_size;
    const gr = mctx?.growth;
    const cnt = DATA.news?.meta?.counts?.[rid] || 0;
    const signal = DATA.briefings?.regions?.[rid]?.signals?.[0]?.signal || 'Monitoringâ€¦';
    const hStatus = DATA.health?.regions?.[rid]?.status || 'ok';

    cardsHtml += `
    <div class="region-card" onclick="switchTab('${rid}')">
      <div class="region-card-hd">
        <span class="region-card-flag">${meta.flag}</span>
        <span class="region-card-name">${meta.name}</span>
      </div>
      <div class="region-card-stats">
        <div class="rc-stat">
          <div class="rc-stat-val">${formatMarketSize(ms)} ${statPopover(ms)}</div>
          <div class="rc-stat-lbl">Market (est.)</div>
        </div>
        <div class="rc-stat">
          <div class="rc-stat-val" style="color:var(--green)">${formatGrowth(gr)} ${statPopover(gr)}</div>
          <div class="rc-stat-lbl">Growth (est.)</div>
        </div>
      </div>
      <div class="region-card-signal" style="background:${hStatus==='error'?'#FFEBEE':hStatus==='warning'?'#FFF8E1':'#E8F5E9'};color:${hStatus==='error'?'#C62828':hStatus==='warning'?'#F57F17':'#2E7D32'}">
        ${signal} Â· ${cnt} items
      </div>
    </div>`;
  }

  // Global news (all regions combined, sorted by score)
  let allNews = [];
  if (DATA.news?.regions) {
    for (const [rid, arts] of Object.entries(DATA.news.regions)) {
      allNews.push(...arts);
    }
  }
  allNews.sort((a,b) => (b.score||0) - (a.score||0));
  const topNews = allNews.slice(0, 30);

  // Filter buttons
  const catSet = new Set(topNews.map(n => n.category));
  let filterHtml = `<button class="cat-btn active" onclick="filterNews('all',this)">All</button>`;
  for (const cat of Object.keys(CAT_LABELS)) {
    if (cat !== 'all' && catSet.has(cat)) {
      filterHtml += `<button class="cat-btn" onclick="filterNews('${cat}',this)">${CAT_LABELS[cat]}</button>`;
    }
  }

  panel.innerHTML = `
    <div class="insight-box">
      <div class="insight-label">ğŸ“¡ Morning Briefing Â· ${new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
      <div class="insight-text">${briefingText}</div>
      <div class="insight-source">Generated via RSS analysis Â· Updated ${genAt} Â· No paid APIs</div>
    </div>

    <div class="global-grid">${cardsHtml}</div>

    <div class="filter-bar">
      <div style="font-family:var(--font-display);font-size:1.1rem;color:var(--navy);">All Markets â€” Latest Intelligence</div>
      <div class="cat-filters">${filterHtml}</div>
    </div>

    <div class="panel">
      <div class="panel-body">
        <div class="news-list" id="global-news-list">
          ${topNews.length ? topNews.map(newsHtml).join('') : '<div style="padding:20px;text-align:center;color:var(--text-light);">No articles yet. Run the pipeline to fetch data.</div>'}
        </div>
      </div>
    </div>`;
}

function filterNews(cat, btn) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('#global-news-list .news-item, .region-news-list .news-item').forEach(el => {
    el.style.display = (cat === 'all' || el.dataset.cat === cat) ? 'block' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REGION VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRegion(rid) {
  const panel = document.getElementById(`panel-${rid}`);
  const meta = REGION_META[rid];
  const mctx = DATA.stats?.regions?.[rid]?.market_context;
  const brief = DATA.briefings?.regions?.[rid];
  const articles = DATA.news?.regions?.[rid] || [];
  const h = DATA.health?.regions?.[rid];

  // Executive summary
  const execHtml = (brief?.executive_summary || []).map(s => `
    <div class="briefing-item">
      <div class="bi-headline">${s.headline}</div>
      <div class="bi-detail">${s.detail}</div>
      <div class="bi-meta"><span class="news-conf conf-${s.confidence}">${s.confidence}</span>
        ${(s.evidence_urls||[]).map(u => `<a href="${u}" target="_blank" class="bi-link">source</a>`).join(' ')}
      </div>
    </div>`).join('') || '<div style="color:var(--text-light);font-size:0.78rem;">No executive summary available yet.</div>';

  // Signals
  const signalsHtml = (brief?.signals || []).map(s => `
    <div class="briefing-item">
      <div class="bi-headline">${s.signal}</div>
      <div class="bi-detail">${s.explanation}</div>
      <div class="bi-meta"><span class="news-conf conf-${s.confidence}">${s.confidence}</span> Â· ${s.support_count} supporting articles</div>
    </div>`).join('') || '';

  // Talking points
  const tpHtml = (brief?.talking_points || []).map(tp => `
    <div class="briefing-item">
      <div class="bi-headline" style="color:var(--accent);">ğŸ¯ ${tp.customer_type.toUpperCase()}</div>
      <div class="bi-detail">${tp.pitch}</div>
      <div class="bi-meta">${(tp.supporting_evidence_urls||[]).map(u => `<a href="${u}" target="_blank" class="bi-link">evidence</a>`).join(' ')}</div>
    </div>`).join('') || '';

  // Actions
  const actHtml = (brief?.recommended_actions || []).map(a => `
    <div class="briefing-item" style="border-left:3px solid var(--accent2);">
      <div class="bi-headline">âš¡ ${a.action}</div>
      <div class="bi-detail">${a.why_now}</div>
      <div class="bi-meta">${(a.evidence_urls||[]).map(u => `<a href="${u}" target="_blank" class="bi-link">evidence</a>`).join(' ')}</div>
    </div>`).join('') || '';

  // Key launches
  const launchHtml = (brief?.key_launches || []).map(l => `
    <div class="briefing-item">
      <div class="bi-headline">${l.title}</div>
      <div class="bi-detail">${l.company} Â· ${l.product}</div>
      <div class="bi-meta"><a href="${l.evidence_url}" target="_blank" class="bi-link">source</a> Â· ${l.date ? new Date(l.date).toLocaleDateString('en-GB',{day:'numeric',month:'short'}) : ''}</div>
    </div>`).join('') || '<div style="color:var(--text-light);font-size:0.78rem;">No launches tracked yet.</div>';

  // Regulatory
  const regHtml = (brief?.regulatory_watch || []).map(r => `
    <div class="briefing-item" style="border-left:3px solid #6A1B9A;">
      <div class="bi-headline">âš–ï¸ ${r.title}</div>
      <div class="bi-detail">${r.impact_on_sales}</div>
      <div class="bi-meta"><a href="${r.evidence_url}" target="_blank" class="bi-link">source</a></div>
    </div>`).join('') || '<div style="color:var(--text-light);font-size:0.78rem;">No regulatory items tracked.</div>';

  // News filter
  const catSet = new Set(articles.map(n => n.category));
  let filterHtml = `<button class="cat-btn active" onclick="filterRegionNews('${rid}','all',this)">All</button>`;
  for (const cat of Object.keys(CAT_LABELS)) {
    if (cat !== 'all' && catSet.has(cat)) {
      filterHtml += `<button class="cat-btn" onclick="filterRegionNews('${rid}','${cat}',this)">${CAT_LABELS[cat]}</button>`;
    }
  }

  // Health warning
  const healthNote = h?.notes?.length ? `<div style="background:#FFF8E1;border-radius:8px;padding:8px 14px;margin-bottom:12px;font-family:var(--font-mono);font-size:0.6rem;color:#F57F17;">âš  ${h.notes.join(' Â· ')}</div>` : '';

  panel.innerHTML = `
    ${healthNote}
    <div class="insight-box">
      <div class="insight-label">${meta.flag} ${meta.name} â€” Sales Intelligence</div>
      <div class="insight-text">${execHtml}</div>
      <div class="insight-source">
        Market: ${formatMarketSize(mctx?.market_size)} ${statPopover(mctx?.market_size)} Â· Growth: ${formatGrowth(mctx?.growth)} ${statPopover(mctx?.growth)}
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:16px;">
      <button class="copy-btn" onclick="copyBriefing('${rid}')">ğŸ“‹ Copy Briefing</button>
    </div>

    <div class="intel-grid">
      <div>
        ${signalsHtml ? `<div class="panel"><div class="panel-hd"><div class="panel-title">ğŸ“¡ Market Signals</div></div><div class="panel-body">${signalsHtml}</div></div>` : ''}
        <div class="panel"><div class="panel-hd"><div class="panel-title">ğŸš€ Key Launches</div><span class="panel-badge badge-launch">Tracked</span></div><div class="panel-body">${launchHtml}</div></div>
        <div class="panel"><div class="panel-hd"><div class="panel-title">âš–ï¸ Regulatory Watch</div><span class="panel-badge badge-regulatory">Monitor</span></div><div class="panel-body">${regHtml}</div></div>
      </div>
      <div>
        ${tpHtml ? `<div class="panel"><div class="panel-hd"><div class="panel-title">ğŸ¯ Talking Points</div></div><div class="panel-body">${tpHtml}</div></div>` : ''}
        ${actHtml ? `<div class="panel"><div class="panel-hd"><div class="panel-title">âš¡ Recommended Actions</div><span class="panel-badge badge-action">Sales</span></div><div class="panel-body">${actHtml}</div></div>` : ''}
      </div>
    </div>

    <div class="filter-bar" style="margin-top:20px;">
      <div style="font-family:var(--font-display);font-size:1rem;color:var(--navy);">ğŸ“° All ${meta.name} Intelligence (${articles.length})</div>
      <div class="cat-filters">${filterHtml}</div>
    </div>
    <div class="panel">
      <div class="panel-body">
        <div class="news-list region-news-list" id="news-${rid}">
          ${articles.length ? articles.map(newsHtml).join('') : '<div style="padding:20px;text-align:center;color:var(--text-light);">No articles available. Run pipeline.</div>'}
        </div>
      </div>
    </div>`;
}

function filterRegionNews(rid, cat, btn) {
  btn.parentElement.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll(`#news-${rid} .news-item`).forEach(el => {
    el.style.display = (cat === 'all' || el.dataset.cat === cat) ? 'block' : 'none';
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY BRIEFING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyBriefing(rid) {
  const b = DATA.briefings?.regions?.[rid];
  if (!b) { alert('No briefing data available.'); return; }
  const meta = REGION_META[rid];
  let text = `ğŸ“Š ${meta.name} SALES BRIEFING\n${'='.repeat(40)}\n\n`;

  text += `EXECUTIVE SUMMARY\n`;
  (b.executive_summary || []).forEach(s => { text += `â€¢ ${s.headline}\n  ${s.detail}\n\n`; });

  text += `\nTALKING POINTS\n`;
  (b.talking_points || []).forEach(tp => { text += `ğŸ¯ [${tp.customer_type.toUpperCase()}] ${tp.pitch}\n`; });

  text += `\nRECOMMENDED ACTIONS\n`;
  (b.recommended_actions || []).forEach(a => { text += `âš¡ ${a.action} â€” ${a.why_now}\n`; });

  text += `\n---\nGenerated: ${DATA.briefings.generated_at || 'unknown'}\nSource: Sales Intelligence Pipeline (RSS analysis)\n`;

  navigator.clipboard.writeText(text).then(
    () => { alert('Briefing copied to clipboard!'); },
    () => { prompt('Copy this briefing:', text); }
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  const el = document.getElementById('clock');
  if (el) el.textContent = now.toLocaleDateString('en-DE',{weekday:'short',day:'numeric',month:'short'}) + ' Â· ' + now.toLocaleTimeString('de-DE');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
updateClock();
setInterval(updateClock, 1000);
loadAllData();
</script>
</body>
</html>
