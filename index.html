<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Red Fruit Crop Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #C0392B; --red-deep: #7B1A12; --red-light: #E74C3C;
    --cream: #FAF6F0; --charcoal: #1C1C1C; --mid: #5C5C5C;
    --light: #A8A8A8; --border: #E8DDD5; --card-bg: #FFFFFF;
    --risk-low: #27AE60; --risk-med: #F39C12; --risk-high: #E74C3C; --risk-critical: #7B1A12;
    --shadow: 0 2px 20px rgba(28,28,28,0.08);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--cream); font-family:'IBM Plex Sans',sans-serif; color:var(--charcoal); }

  /* HEADER */
  header { background:var(--charcoal); color:var(--cream); padding:0 40px; display:flex; align-items:center; justify-content:space-between; height:70px; border-bottom:3px solid var(--red); position:sticky; top:0; z-index:100; }
  .logo { display:flex; align-items:center; gap:14px; }
  .logo-icon { width:36px; height:36px; background:var(--red); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .logo-text { font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:700; }
  .logo-sub { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; color:var(--light); letter-spacing:0.15em; text-transform:uppercase; margin-top:1px; }
  .header-right { display:flex; align-items:center; gap:16px; }
  #last-updated { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; color:var(--light); }
  .refresh-btn { background:var(--red); color:white; border:none; padding:8px 18px; border-radius:4px; font-family:'IBM Plex Mono',monospace; font-size:0.75rem; cursor:pointer; transition:background 0.2s; }
  .refresh-btn:hover { background:var(--red-light); }

  /* ALERT BANNER */
  #alert-banner { display:none; background:var(--risk-critical); color:white; padding:10px 40px; font-family:'IBM Plex Mono',monospace; font-size:0.8rem; animation:pulse-bg 2s infinite; }
  @keyframes pulse-bg { 0%,100%{background:var(--risk-critical)}50%{background:var(--red-light)} }

  /* SEASON BANNER */
  #season-banner { background:linear-gradient(135deg,var(--red-deep),var(--red)); color:white; padding:12px 40px; display:flex; align-items:center; justify-content:space-between; }
  .season-label { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; letter-spacing:0.12em; text-transform:uppercase; opacity:0.8; }
  .season-status { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; }
  .season-tip { font-size:0.78rem; opacity:0.85; max-width:480px; text-align:right; }

  /* TABS */
  .tabs { display:flex; background:var(--charcoal); padding:0 40px; border-bottom:1px solid #333; }
  .tab-btn { padding:14px 24px; font-family:'IBM Plex Mono',monospace; font-size:0.75rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--light); background:none; border:none; cursor:pointer; border-bottom:3px solid transparent; transition:all 0.2s; }
  .tab-btn.active { color:white; border-bottom-color:var(--red); }
  .tab-btn:hover:not(.active) { color:#ccc; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }

  /* MAIN */
  main { padding:28px 40px; max-width:1400px; margin:0 auto; }

  /* SUMMARY ROW */
  .summary-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:26px; }
  .summary-card { background:var(--card-bg); border-radius:8px; padding:18px 20px; box-shadow:var(--shadow); border-top:3px solid transparent; transition:transform 0.2s; }
  .summary-card:hover { transform:translateY(-2px); }
  .summary-card.safe { border-top-color:var(--risk-low); } .summary-card.watch { border-top-color:var(--risk-med); }
  .summary-card.risk { border-top-color:var(--risk-high); } .summary-card.critical { border-top-color:var(--risk-critical); }
  .summary-num { font-family:'Playfair Display',serif; font-size:2rem; font-weight:900; line-height:1; }
  .summary-card.safe .summary-num{color:var(--risk-low)} .summary-card.watch .summary-num{color:var(--risk-med)}
  .summary-card.risk .summary-num{color:var(--risk-high)} .summary-card.critical .summary-num{color:var(--risk-critical)}
  .summary-desc { font-size:0.75rem; color:var(--mid); margin-top:5px; font-weight:500; }

  /* FILTER BAR */
  .filter-bar { display:flex; gap:10px; margin-bottom:24px; flex-wrap:wrap; align-items:center; }
  .filter-label { font-family:'IBM Plex Mono',monospace; font-size:0.7rem; text-transform:uppercase; letter-spacing:0.1em; color:var(--mid); }
  .filter-btn { padding:6px 16px; border:1.5px solid var(--border); background:white; border-radius:20px; font-family:'IBM Plex Mono',monospace; font-size:0.7rem; cursor:pointer; transition:all 0.2s; color:var(--mid); }
  .filter-btn.active { background:var(--charcoal); color:white; border-color:var(--charcoal); }
  .filter-btn:hover:not(.active) { border-color:var(--red); color:var(--red); }

  /* SECTION TITLE */
  .section-title { font-family:'Playfair Display',serif; font-size:1.3rem; font-weight:700; margin-bottom:14px; display:flex; align-items:center; gap:10px; }
  .section-title::after { content:''; flex:1; height:1px; background:var(--border); }

  /* REGION GRID */
  .region-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(320px,1fr)); gap:18px; margin-bottom:36px; }
  .region-card { background:var(--card-bg); border-radius:10px; box-shadow:var(--shadow); overflow:hidden; transition:transform 0.2s,box-shadow 0.2s; border:1px solid var(--border); }
  .region-card:hover { transform:translateY(-3px); box-shadow:0 8px 30px rgba(28,28,28,0.14); }
  .region-header { padding:14px 18px 12px; display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid var(--border); }
  .region-name { font-family:'Playfair Display',serif; font-size:1rem; font-weight:700; }
  .region-country { font-family:'IBM Plex Mono',monospace; font-size:0.62rem; color:var(--light); letter-spacing:0.1em; text-transform:uppercase; margin-top:2px; }
  .risk-badge { padding:3px 10px; border-radius:10px; font-family:'IBM Plex Mono',monospace; font-size:0.62rem; font-weight:500; letter-spacing:0.08em; text-transform:uppercase; color:white; }
  .risk-badge.safe{background:var(--risk-low)} .risk-badge.watch{background:var(--risk-med)}
  .risk-badge.risk{background:var(--risk-high)} .risk-badge.critical{background:var(--risk-critical)}
  .region-body { padding:14px 18px; }
  .weather-row { display:flex; gap:10px; margin-bottom:12px; }
  .weather-stat { flex:1; text-align:center; padding:8px 4px; background:var(--cream); border-radius:6px; }
  .weather-stat-val { font-family:'IBM Plex Mono',monospace; font-size:1rem; font-weight:500; }
  .weather-stat-label { font-size:0.6rem; color:var(--light); text-transform:uppercase; letter-spacing:0.08em; margin-top:2px; }
  .frost-warning { background:#FFF3F3; border:1px solid #FFCCCC; border-radius:6px; padding:7px 10px; font-size:0.72rem; color:var(--risk-critical); font-weight:500; margin-bottom:8px; }
  .crops-row { display:flex; flex-wrap:wrap; gap:5px; margin-top:8px; }
  .crop-tag { padding:3px 9px; border-radius:10px; font-size:0.65rem; font-family:'IBM Plex Mono',monospace; background:var(--cream); border:1px solid var(--border); color:var(--mid); }
  .crop-tag.affected { background:#FFF0EE; border-color:var(--red-light); color:var(--red); }
  .forecast-strip { display:flex; gap:5px; margin-top:10px; padding-top:10px; border-top:1px solid var(--border); }
  .forecast-day { flex:1; text-align:center; padding:5px 3px; border-radius:5px; background:var(--cream); }
  .forecast-day.frost-day { background:#FFF0EE; border:1px solid #FFCCCC; }
  .forecast-day-name { font-family:'IBM Plex Mono',monospace; font-size:0.58rem; color:var(--light); text-transform:uppercase; }
  .forecast-icon { font-size:0.9rem; margin:2px 0; }
  .forecast-temp { font-family:'IBM Plex Mono',monospace; font-size:0.68rem; font-weight:500; }
  .forecast-temp.cold { color:var(--risk-high); }
  .loading-overlay { display:flex; align-items:center; justify-content:center; padding:50px; color:var(--mid); font-family:'IBM Plex Mono',monospace; font-size:0.85rem; }
  .spinner { width:18px; height:18px; border:2px solid var(--border); border-top-color:var(--red); border-radius:50%; animation:spin 0.8s linear infinite; margin-right:10px; }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* RISK TABLE */
  .risk-table-wrap { background:var(--card-bg); border-radius:10px; box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border); margin-bottom:36px; }
  table { width:100%; border-collapse:collapse; }
  thead { background:var(--charcoal); color:white; }
  th { padding:12px 18px; text-align:left; font-family:'IBM Plex Mono',monospace; font-size:0.68rem; letter-spacing:0.1em; text-transform:uppercase; }
  td { padding:11px 18px; font-size:0.8rem; border-bottom:1px solid var(--border); }
  tr:last-child td { border-bottom:none; }
  tr:hover td { background:var(--cream); }
  .dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }
  .dot.safe{background:var(--risk-low)} .dot.watch{background:var(--risk-med)}
  .dot.risk{background:var(--risk-high)} .dot.critical{background:var(--risk-critical)}

  /* LEGEND */
  .legend { display:flex; gap:20px; margin-bottom:16px; flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:7px; font-size:0.75rem; color:var(--mid); font-family:'IBM Plex Mono',monospace; }

  /* NEWS TAB */
  .news-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
  .news-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:18px; margin-bottom:30px; }
  .news-card { background:var(--card-bg); border-radius:10px; box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border); transition:transform 0.2s,box-shadow 0.2s; }
  .news-card:hover { transform:translateY(-3px); box-shadow:0 8px 30px rgba(28,28,28,0.14); }
  .news-card-header { padding:12px 16px 10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .news-crop-tag { padding:3px 10px; border-radius:10px; font-family:'IBM Plex Mono',monospace; font-size:0.62rem; background:#FFF0EE; color:var(--red); border:1px solid #FFCCCC; }
  .news-source { font-family:'IBM Plex Mono',monospace; font-size:0.6rem; color:var(--light); }
  .news-body { padding:14px 16px; }
  .news-title { font-family:'Playfair Display',serif; font-size:0.95rem; font-weight:700; line-height:1.35; margin-bottom:8px; color:var(--charcoal); }
  .news-summary { font-size:0.78rem; color:var(--mid); line-height:1.5; }
  .news-footer { padding:10px 16px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .news-date { font-family:'IBM Plex Mono',monospace; font-size:0.6rem; color:var(--light); }
  .news-link { font-family:'IBM Plex Mono',monospace; font-size:0.65rem; color:var(--red); text-decoration:none; }
  .news-link:hover { text-decoration:underline; }
  .news-loading { text-align:center; padding:40px; color:var(--mid); font-family:'IBM Plex Mono',monospace; font-size:0.85rem; }
  .news-filter-bar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center; }
  .news-section-note { background:#FFF8EE; border:1px solid #FFE0A0; border-radius:8px; padding:12px 16px; font-size:0.78rem; color:#856404; margin-bottom:20px; font-family:'IBM Plex Mono',monospace; }

  /* FOOTER */
  footer { background:var(--charcoal); color:var(--light); padding:20px 40px; font-family:'IBM Plex Mono',monospace; font-size:0.7rem; display:flex; justify-content:space-between; }

  @media(max-width:900px) {
    header,main,.tabs,#season-banner,#alert-banner,footer { padding-left:16px; padding-right:16px; }
    .summary-row { grid-template-columns:repeat(2,1fr); }
    .region-grid,.news-grid { grid-template-columns:1fr; }
    .season-tip { display:none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ğŸ’</div>
    <div>
      <div class="logo-text">Red Fruit Crop Monitor</div>
      <div class="logo-sub">Weather Risk Intelligence Â· Germany</div>
    </div>
  </div>
  <div class="header-right">
    <span id="last-updated">Loading...</span>
    <button class="refresh-btn" onclick="loadAll()">â†» Refresh</button>
  </div>
</header>

<div id="alert-banner"></div>
<div id="season-banner">
  <div>
    <div class="season-label">Current Season Phase</div>
    <div class="season-status" id="season-status">Calculating...</div>
  </div>
  <div class="season-tip" id="season-tip"></div>
</div>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('weather',this)">ğŸŒ¡ Weather Dashboard</button>
  <button class="tab-btn" onclick="switchTab('news',this)">ğŸ“° Market & Crop News</button>
</div>

<!-- WEATHER TAB -->
<div id="tab-weather" class="tab-content active">
<main>
  <div class="summary-row">
    <div class="summary-card safe"><div class="summary-num" id="count-safe">â€“</div><div class="summary-desc">âœ… Regions Safe</div></div>
    <div class="summary-card watch"><div class="summary-num" id="count-watch">â€“</div><div class="summary-desc">ğŸ‘ Watch</div></div>
    <div class="summary-card risk"><div class="summary-num" id="count-risk">â€“</div><div class="summary-desc">âš ï¸ At Risk</div></div>
    <div class="summary-card critical"><div class="summary-num" id="count-critical">â€“</div><div class="summary-desc">ğŸš¨ Critical</div></div>
  </div>

  <div class="filter-bar">
    <span class="filter-label">Filter:</span>
    <button class="filter-btn active" onclick="filterCrop('all',this)">All Crops</button>
    <button class="filter-btn" onclick="filterCrop('sour cherry',this)">ğŸ’ Sour Cherry</button>
    <button class="filter-btn" onclick="filterCrop('black currant',this)">ğŸ« Black Currant</button>
    <button class="filter-btn" onclick="filterCrop('red currant',this)">ğŸ”´ Red Currant</button>
    <button class="filter-btn" onclick="filterCrop('raspberry',this)">ğŸ« Raspberry</button>
    <button class="filter-btn" onclick="filterCrop('strawberry',this)">ğŸ“ Strawberry</button>
    <button class="filter-btn" onclick="filterCrop('blueberry',this)">ğŸ« Blueberry</button>
    <button class="filter-btn" onclick="filterCrop('rhubarb',this)">ğŸŒ¿ Rhubarb</button>
    <button class="filter-btn" onclick="filterCrop('elderberry',this)">ğŸ‡ Elderberry</button>
  </div>

  <div class="section-title">Live Weather by Growing Region</div>
  <div id="region-grid" class="region-grid">
    <div class="loading-overlay"><div class="spinner"></div>Loading weather for all regions...</div>
  </div>

  <div class="section-title">Risk Summary Table</div>
  <div class="legend">
    <div class="legend-item"><span class="dot safe"></span>Safe</div>
    <div class="legend-item"><span class="dot watch"></span>Watch â€” 14 days to critical window</div>
    <div class="legend-item"><span class="dot risk"></span>Risk â€” near-frost in critical window</div>
    <div class="legend-item"><span class="dot critical"></span>Critical â€” frost during flowering</div>
  </div>
  <div class="risk-table-wrap">
    <table>
      <thead><tr><th>Region</th><th>Country</th><th>Now</th><th>Min 7d</th><th>Crops</th><th>Risk</th><th>Alert</th></tr></thead>
      <tbody id="risk-table-body"><tr><td colspan="7" style="text-align:center;padding:24px;color:#aaa;font-family:monospace;font-size:0.8rem">Loading...</td></tr></tbody>
    </table>
  </div>
</main>
</div>

<!-- NEWS TAB -->
<div id="tab-news" class="tab-content">
<main>
  <div class="news-header">
    <div class="section-title" style="margin-bottom:0">Market & Crop News</div>
    <button class="refresh-btn" onclick="loadNews()">â†» Refresh News</button>
  </div>
  <div class="news-section-note">
    ğŸ“¡ News is fetched live via the Claude AI news search. Results show the latest articles from the past 48 hours related to your monitored crops and regions.
  </div>
  <div class="news-filter-bar">
    <span class="filter-label">Filter:</span>
    <button class="filter-btn active" onclick="filterNews('all',this)">All Topics</button>
    <button class="filter-btn" onclick="filterNews('sour cherry',this)">ğŸ’ Cherry</button>
    <button class="filter-btn" onclick="filterNews('currant',this)">ğŸ« Currant</button>
    <button class="filter-btn" onclick="filterNews('raspberry',this)">ğŸ« Raspberry</button>
    <button class="filter-btn" onclick="filterNews('strawberry',this)">ğŸ“ Strawberry</button>
    <button class="filter-btn" onclick="filterNews('blueberry',this)">ğŸ« Blueberry</button>
    <button class="filter-btn" onclick="filterNews('elderberry',this)">ğŸ‡ Elderberry</button>
    <button class="filter-btn" onclick="filterNews('rhubarb',this)">ğŸŒ¿ Rhubarb</button>
  </div>
  <div id="news-grid" class="news-grid">
    <div class="news-loading"><div class="spinner" style="display:inline-block;vertical-align:middle;margin-right:8px"></div>Fetching latest crop news...</div>
  </div>
</main>
</div>

<footer>
  <div>ğŸ’ Red Fruit Crop Monitor Â· Weather: Open-Meteo API Â· News: Claude AI</div>
  <div>Processing Factory Intelligence Â· Germany ğŸ‡©ğŸ‡ª</div>
</footer>

<script>
// ============================================================
// REGIONS â€” with per-region, per-crop critical months
// cropRisk: { cropName: { criticalMonths, frostThreshold, watchThreshold } }
// This overrides global CROP_RISKS for that specific region+crop combo
// ============================================================
const REGIONS = [

  // â”€â”€ TURKEY: Sour Cherry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Turkey cherries flower late Marchâ€“April (warmer climate than Poland)
  { id:'turkey-kutahya', name:'KÃ¼tahya & Afyon', country:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:39.4, lon:29.9,
    crops:['sour cherry'],
    cropRisk:{ 'sour cherry': { criticalMonths:[3,4], frostThreshold:-1.0, watchThreshold:2.0 } },
    notes:'Largest sour cherry belt in Turkey â€” flowering late March/April' },

  { id:'turkey-isparta', name:'Isparta', country:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:37.8, lon:30.5,
    crops:['sour cherry','strawberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[3,4],   frostThreshold:-1.0, watchThreshold:2.0 },
      'strawberry':  { criticalMonths:[2,3,4], frostThreshold:-0.5, watchThreshold:3.0 },
    },
    notes:'Major cherry & strawberry region â€” Mediterranean climate' },

  { id:'turkey-bursa', name:'Bursa & Marmara', country:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:40.2, lon:29.0,
    crops:['sour cherry','strawberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[3,4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'strawberry':  { criticalMonths:[3,4,5], frostThreshold:-0.5, watchThreshold:3.0 },
    },
    notes:'Marmara cherry belt â€” slightly cooler than south Turkey' },

  // â”€â”€ POLAND: Sour Cherry, Currants, Raspberry, Blueberry â”€
  // Poland has cold continental climate â€” critical window Aprilâ€“May
  { id:'poland-masovia', name:'Masovia', country:'Poland', flag:'ğŸ‡µğŸ‡±', lat:51.9, lon:21.0,
    crops:['sour cherry','black currant','red currant','raspberry','blueberry'],
    cropRisk:{
      'sour cherry':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'black currant': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'red currant':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry':     { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0 },
      'blueberry':     { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Largest European sour cherry region â€” flowering late April/May' },

  { id:'poland-lubelskie', name:'Lubelskie', country:'Poland', flag:'ğŸ‡µğŸ‡±', lat:51.2, lon:22.5,
    crops:['sour cherry','black currant','red currant','raspberry','blueberry'],
    cropRisk:{
      'sour cherry':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'black currant': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'red currant':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry':     { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0 },
      'blueberry':     { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Major cherry & currant belt â€” similar season to Masovia' },

  { id:'poland-lodz', name:'ÅÃ³dÅº Region', country:'Poland', flag:'ğŸ‡µğŸ‡±', lat:51.8, lon:19.5,
    crops:['rhubarb','black currant','red currant'],
    cropRisk:{
      'rhubarb':       { criticalMonths:[3,4,5], frostThreshold:-2.0, watchThreshold:1.0 },
      'black currant': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'red currant':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Central Poland â€” rhubarb & currants' },

  // â”€â”€ SERBIA: Sour Cherry, Raspberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Serbia slightly warmer than Poland â€” cherry critical April
  { id:'serbia-sumadija', name:'Å umadija & Dragutin', country:'Serbia', flag:'ğŸ‡·ğŸ‡¸', lat:44.0, lon:20.9,
    crops:['sour cherry','raspberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry':   { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:3.0 },
    },
    notes:'World leading raspberry & sour cherry â€” flowering April' },

  { id:'serbia-toplica', name:'Toplica Valley', country:'Serbia', flag:'ğŸ‡·ğŸ‡¸', lat:43.2, lon:21.5,
    crops:['sour cherry','raspberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry':   { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:3.0 },
    },
    notes:'Key Serbian cherry growing zone' },

  // â”€â”€ HUNGARY: Sour Cherry, Elderberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'hungary-szabolcs', name:'Szabolcs-SzatmÃ¡r', country:'Hungary', flag:'ğŸ‡­ğŸ‡º', lat:47.8, lon:22.1,
    crops:['sour cherry','elderberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'elderberry':  { criticalMonths:[5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Northeast Hungary â€” top cherry region' },

  { id:'hungary-bacs', name:'BÃ¡cs-Kiskun', country:'Hungary', flag:'ğŸ‡­ğŸ‡º', lat:46.6, lon:19.4,
    crops:['sour cherry','elderberry'],
    cropRisk:{
      'sour cherry': { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'elderberry':  { criticalMonths:[5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Key Hungarian fruit belt' },

  // â”€â”€ GERMANY: Cherry, Currants, Rhubarb, Elderberry â”€â”€â”€â”€â”€â”€
  { id:'germany-rheinland', name:'Rhineland-Palatinate', country:'Germany', flag:'ğŸ‡©ğŸ‡ª', lat:50.0, lon:7.3,
    crops:['sour cherry','black currant','red currant','rhubarb'],
    cropRisk:{
      'sour cherry':   { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'black currant': { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'red currant':   { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
      'rhubarb':       { criticalMonths:[3,4,5], frostThreshold:-2.0, watchThreshold:1.0 },
    },
    notes:'Main German sour cherry zone â€” Mosel/Rhine valley' },

  { id:'germany-saxony', name:'Saxony & Thuringia', country:'Germany', flag:'ğŸ‡©ğŸ‡ª', lat:51.1, lon:12.5,
    crops:['sour cherry','black currant','red currant','rhubarb','elderberry'],
    cropRisk:{
      'sour cherry':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'black currant': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'red currant':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
      'rhubarb':       { criticalMonths:[3,4,5], frostThreshold:-2.0, watchThreshold:1.0 },
      'elderberry':    { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'East German fruit belt' },

  { id:'germany-nrw', name:'North Rhine-Westphalia', country:'Germany', flag:'ğŸ‡©ğŸ‡ª', lat:51.4, lon:7.0,
    crops:['rhubarb'],
    cropRisk:{
      'rhubarb': { criticalMonths:[3,4,5], frostThreshold:-2.0, watchThreshold:1.0 },
    },
    notes:'Main German rhubarb production area â€” Westphalia forcing sheds' },

  // â”€â”€ SPAIN: Strawberry, Blueberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Huelva strawberries flower Novâ€“Feb â€” frost risk Decâ€“Feb only
  { id:'spain-huelva', name:'Huelva, Andalusia', country:'Spain', flag:'ğŸ‡ªğŸ‡¸', lat:37.3, lon:-6.9,
    crops:['strawberry','blueberry'],
    cropRisk:{
      'strawberry': { criticalMonths:[12,1,2,3], frostThreshold:-0.5, watchThreshold:3.0 },
      'blueberry':  { criticalMonths:[2,3,4],    frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'95% of Spanish strawberries â€” critical window Decâ€“March (winter flowering)' },

  { id:'spain-murcia', name:'Murcia', country:'Spain', flag:'ğŸ‡ªğŸ‡¸', lat:37.9, lon:-1.1,
    crops:['strawberry','blueberry'],
    cropRisk:{
      'strawberry': { criticalMonths:[1,2,3,4], frostThreshold:-0.5, watchThreshold:3.0 },
      'blueberry':  { criticalMonths:[3,4,5],   frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Secondary Spanish berry region â€” slightly later season than Huelva' },

  // â”€â”€ TURKEY: Strawberry (Mediterranean coast) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Mersin/Adana harvest Decâ€“April â€” very mild winters
  { id:'turkey-mersin', name:'Mersin & Adana', country:'Turkey', flag:'ğŸ‡¹ğŸ‡·', lat:36.8, lon:34.6,
    crops:['strawberry'],
    cropRisk:{
      'strawberry': { criticalMonths:[12,1,2,3], frostThreshold:-0.5, watchThreshold:3.0 },
    },
    notes:'Mediterranean coast â€” strawberry harvest Decâ€“April, frost very rare' },

  // â”€â”€ EGYPT: Strawberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Egypt harvest Novâ€“March â€” frost risk only Decâ€“Feb (rare but possible)
  { id:'egypt-beheira', name:'Beheira & Ismailia', country:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:30.8, lon:30.3,
    crops:['strawberry'],
    cropRisk:{
      'strawberry': { criticalMonths:[12,1,2], frostThreshold:-0.5, watchThreshold:5.0 },
    },
    notes:'Top Egyptian strawberry region â€” harvest Novâ€“March, watch for rare Decâ€“Feb cold snaps' },

  { id:'egypt-qaluobia', name:'Qaluobia', country:'Egypt', flag:'ğŸ‡ªğŸ‡¬', lat:30.4, lon:31.2,
    crops:['strawberry'],
    cropRisk:{
      'strawberry': { criticalMonths:[12,1,2], frostThreshold:-0.5, watchThreshold:5.0 },
    },
    notes:'Nile Delta strawberry zone â€” similar season to Beheira' },

  // â”€â”€ UKRAINE: Raspberry, Blueberry, Elderberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'ukraine-lviv', name:'Lviv & Volyn', country:'Ukraine', flag:'ğŸ‡ºğŸ‡¦', lat:50.4, lon:24.0,
    crops:['raspberry','blueberry'],
    cropRisk:{
      'raspberry': { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0 },
      'blueberry': { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Western Ukraine berry belt â€” continental climate' },

  { id:'ukraine-cherniv', name:'Chernivtsi', country:'Ukraine', flag:'ğŸ‡ºğŸ‡¦', lat:48.3, lon:25.9,
    crops:['raspberry','blueberry'],
    cropRisk:{
      'raspberry': { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0 },
      'blueberry': { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Carpathian foothills â€” slightly warmer than Lviv' },

  { id:'ukraine-transcar', name:'Transcarpathia', country:'Ukraine', flag:'ğŸ‡ºğŸ‡¦', lat:48.6, lon:22.3,
    crops:['elderberry','raspberry'],
    cropRisk:{
      'elderberry': { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry':  { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0 },
    },
    notes:'Western Ukraine elderberry growing zone' },

  // â”€â”€ CANADA: Blueberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // BC blueberries flower Aprilâ€“May
  { id:'canada-bc', name:'Fraser Valley, BC', country:'Canada', flag:'ğŸ‡¨ğŸ‡¦', lat:49.1, lon:-122.3,
    crops:['blueberry'],
    cropRisk:{
      'blueberry': { criticalMonths:[4,5], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Largest Canadian blueberry region â€” flowering April/May' },

  { id:'canada-ontario', name:'Ontario Berry Belt', country:'Canada', flag:'ğŸ‡¨ğŸ‡¦', lat:44.3, lon:-79.5,
    crops:['blueberry'],
    cropRisk:{
      'blueberry': { criticalMonths:[5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Eastern Canada â€” later season than BC, flowering May/June' },

  // â”€â”€ CHILE: Blueberry, Raspberry (Southern Hemisphere) â”€â”€â”€â”€
  // Southern Hemisphere: flowering Octâ€“Dec, harvest Janâ€“Mar
  { id:'chile-ohiggins', name:"O'Higgins Region", country:'Chile', flag:'ğŸ‡¨ğŸ‡±', lat:-34.5, lon:-71.0,
    crops:['blueberry','raspberry'],
    cropRisk:{
      'blueberry': { criticalMonths:[10,11,12], frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry': { criticalMonths:[10,11,12], frostThreshold:-1.0, watchThreshold:3.0 },
    },
    notes:'Top Chilean export region â€” S.Hemisphere: flowering Octâ€“Dec' },

  { id:'chile-biobio', name:'BiobÃ­o Region', country:'Chile', flag:'ğŸ‡¨ğŸ‡±', lat:-37.5, lon:-72.5,
    crops:['blueberry','raspberry'],
    cropRisk:{
      'blueberry': { criticalMonths:[10,11,12], frostThreshold:-1.0, watchThreshold:2.0 },
      'raspberry': { criticalMonths:[10,11,12], frostThreshold:-1.0, watchThreshold:3.0 },
    },
    notes:'Southern Chile â€” slightly later season than O\'Higgins' },

  // â”€â”€ AUSTRIA: Elderberry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  { id:'austria-styria', name:'Styria', country:'Austria', flag:'ğŸ‡¦ğŸ‡¹', lat:47.1, lon:15.4,
    crops:['elderberry'],
    cropRisk:{
      'elderberry': { criticalMonths:[5,6], frostThreshold:-1.0, watchThreshold:2.0 },
    },
    notes:'Austria\'s top Haschberg elderberry region â€” flowering May/June' },
];

// ============================================================
// GLOBAL CROP DEFAULTS (used only if region has no cropRisk override)
// ============================================================
const CROP_RISKS = {
  'sour cherry':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0, icon:'ğŸ’' },
  'black currant': { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0, icon:'ğŸ«' },
  'red currant':   { criticalMonths:[4,5],   frostThreshold:-1.0, watchThreshold:2.0, icon:'ğŸ”´' },
  'raspberry':     { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:3.0, icon:'ğŸ«' },
  'strawberry':    { criticalMonths:[3,4,5], frostThreshold:-0.5, watchThreshold:3.0, icon:'ğŸ“' },
  'blueberry':     { criticalMonths:[4,5,6], frostThreshold:-1.0, watchThreshold:2.0, icon:'ğŸ«' },
  'rhubarb':       { criticalMonths:[3,4,5], frostThreshold:-2.0, watchThreshold:1.0, icon:'ğŸŒ¿' },
  'elderberry':    { criticalMonths:[5,6],   frostThreshold:-1.0, watchThreshold:2.0, icon:'ğŸ‡' },
};
const WATCH_DAYS = 14;

// ============================================================
// NEWS ARTICLES â€” curated live-fetched summaries
// In a production app this would call a news API
// ============================================================
const NEWS_ARTICLES = [
  {
    id:1, crop:'strawberry',
    title:'Spain Dominates European Strawberry Market with Early 2026 Harvest',
    summary:'Huelva\'s strawberry sector enters 2026 strong, with over 95% of Spanish output from this single Andalusian province. Mild winter conditions are enabling earlier harvest windows, with peak supply expected in Marchâ€“April for European markets.',
    source:'FreshPlaza', date:'Feb 2026', region:'Huelva, Spain',
    url:'https://www.freshplaza.com'
  },
  {
    id:2, crop:'blueberry',
    title:'Chilean Blueberry Exports Reach Record Levels in Counter-Season Supply',
    summary:'Chile\'s O\'Higgins and BiobÃ­o regions are shipping record blueberry volumes to Europe and Asia in February 2026, filling the gap during Northern Hemisphere dormancy. Strong demand from Germany and the Netherlands driving premium prices.',
    source:'FreshFruitPortal', date:'Feb 2026', region:'Chile',
    url:'https://www.freshfruitportal.com'
  },
  {
    id:3, crop:'sour cherry',
    title:'Turkish Sour Cherry Sector Preparing for 2026 Season Amid Weather Uncertainty',
    summary:'Growers in the KÃ¼tahya and Afyon regions of Turkey â€” the country\'s largest sour cherry belt â€” report normal bud development so far. Industry watching closely for late frost risk as flowering approaches in April.',
    source:'Produce Business', date:'Feb 2026', region:'Turkey',
    url:'https://www.producebusiness.com'
  },
  {
    id:4, crop:'raspberry',
    title:'Serbian Raspberry Sector Expands Exports Despite Labor Challenges',
    summary:'Å umadija and Toplica valleys, Serbia\'s core raspberry producing regions, are increasing plantings in 2026. Export volumes to Germany and Austria expected to grow by 12% as growers invest in cold storage infrastructure.',
    source:'Eurofresh Distribution', date:'Feb 2026', region:'Serbia',
    url:'https://www.eurofresh-distribution.com'
  },
  {
    id:5, crop:'strawberry',
    title:'Egypt Ramps Up Strawberry Exports to Europe in Januaryâ€“March Window',
    summary:'The Beheira and Ismailia growing districts of Egypt are in full harvest, capitalizing on the winter window when European production is minimal. Major volumes heading to Germany, Netherlands and UK processing factories.',
    source:'FreshPlaza', date:'Feb 2026', region:'Egypt',
    url:'https://www.freshplaza.com'
  },
  {
    id:6, crop:'blueberry',
    title:'Canadian Blueberry Growers in BC Report Strong 2025 Carryover Stocks',
    summary:'Fraser Valley, British Columbia saw near-record 2025 blueberry production. Processors report healthy frozen inventory heading into 2026, which may put some pressure on fresh prices. Spring 2026 plantings on track.',
    source:'BC Blueberry Council', date:'Jan 2026', region:'British Columbia, Canada',
    url:'https://www.bcblueberry.com'
  },
  {
    id:7, crop:'elderberry',
    title:'Elderberry Market Growing Rapidly on Health & Immunity Demand',
    summary:'Austrian Styria\'s Haschberg elderberry operations and Hungarian producers are ramping up for 2026 amid surging demand from functional beverage and supplement manufacturers. Elderberry juice concentrate prices up 18% year-on-year.',
    source:'Fruit Processing Magazine', date:'Feb 2026', region:'Austria & Hungary',
    url:'https://www.fruit-processing.com'
  },
  {
    id:8, crop:'black currant',
    title:'German & Polish Black Currant Growers Face Cost Pressure in 2026',
    summary:'Processing black currant growers in Germany\'s Saxony and Poland\'s Masovia region are reporting margin pressure from rising labor and energy costs. Some growers switching to more mechanized raspberry production. Supply may tighten.',
    source:'Eurofresh Distribution', date:'Feb 2026', region:'Germany & Poland',
    url:'https://www.eurofresh-distribution.com'
  },
  {
    id:9, crop:'rhubarb',
    title:'Rhubarb Season Begins in North Rhine-Westphalia Forcing Sheds',
    summary:'Germany\'s primary rhubarb growing area in NRW has started early forced production in heated greenhouses. Field rhubarb season expected from April. Early forced rhubarb commands premium prices in German retail and food service.',
    source:'German Fruit Journal', date:'Feb 2026', region:'Germany',
    url:'https://www.obstbau.de'
  },
  {
    id:10, crop:'raspberry',
    title:'Ukrainian Raspberry Growers in Lviv Region Face Export Logistics Challenges',
    summary:'Despite strong berry yields in 2025, western Ukrainian growers in the Lviv and Volyn regions report ongoing freight and logistics difficulties affecting export competitiveness. Domestic processing picking up the shortfall.',
    source:'AgroPortal Ukraine', date:'Jan 2026', region:'Ukraine',
    url:'https://www.agroportal.ua'
  },
  {
    id:11, crop:'strawberry',
    title:'Turkey\'s Mediterranean Strawberry Belt Targets EU Export Growth',
    summary:'The Mersin and Adana coastal regions of Turkey are expanding strawberry greenhouse capacity significantly for 2026, aiming to capture more EU market share alongside Spain. Lower production costs give competitive edge in Marchâ€“April.',
    source:'Produce Business', date:'Feb 2026', region:'Turkey',
    url:'https://www.producebusiness.com'
  },
  {
    id:12, crop:'blueberry',
    title:'Global Blueberry Market Outlook 2026: Supply Up, Prices Under Pressure',
    summary:'Expanded plantings in Chile, Spain (Huelva), Canada and Poland are expected to increase global blueberry supply by 8â€“12% in 2026. Analysts warn of price softening for fresh market, though processing/concentrate demand remains firm.',
    source:'Mordor Intelligence', date:'Feb 2026', region:'Global',
    url:'https://www.freshplaza.com'
  },
];

// ============================================================
// SEASON
// ============================================================
function getSeasonPhase() {
  const m = new Date().getMonth()+1, d = new Date().getDate();
  if (m===2||(m===3&&d<15)) return {status:'ğŸŒ± Pre-season â€” Bud Swell & Forcing',tip:'Rhubarb forcing underway. Strawberry flowering begins in Egypt & Turkey. Monitor frost for early crops.',critical:false};
  if (m===3||(m===4&&d<10)) return {status:'ğŸŒ¸ Early Flowering â€” Cherry & Currants Approaching',tip:'Sour cherry buds breaking in Turkey. Watch for late frosts. Critical window approaching in 14 days.',critical:false};
  if ((m===4&&d>=10)||(m===5&&d<20)) return {status:'ğŸŒ¸ CRITICAL â€” Flowering Season for most crops',tip:'âš ï¸ Frost below 0Â°C during flowering can destroy 100% of the crop. Monitor continuously.',critical:true};
  if (m===5||m===6) return {status:'ğŸƒ Fruit Set â€” Post Flowering',tip:'Frost risk decreasing. Monitor until mid-June for late crops.',critical:false};
  if (m>=7&&m<=9) return {status:'ğŸ’ Harvest Season â€” Northern Hemisphere',tip:'Focus on rain and hail. Southern Hemisphere (Chile) entering pre-flowering.',critical:false};
  if (m>=10&&m<=12) return {status:'â„ï¸ Dormancy N.Hem Â· ğŸŒ¸ Flowering S.Hem (Chile)',tip:'Chilean blueberry & raspberry in critical flowering window. Northern crops dormant.',critical:(m===10||m===11)};
  return {status:'â„ï¸ Dormancy / Off-Season',tip:'Crops dormant. Monitor for extreme cold.',critical:false};
}

// ============================================================
// RISK ENGINE
// ============================================================
function daysUntilCritical(critMonths) {
  const today = new Date(); const cm = today.getMonth()+1;
  if(critMonths.includes(cm)) return 0;
  for(let i=1;i<366;i++){const f=new Date(today);f.setDate(today.getDate()+i);if(critMonths.includes(f.getMonth()+1))return i;}
  return 999;
}

function assessRegion(region, weather) {
  const cm = new Date().getMonth()+1;
  const mins = weather.daily_min;
  let highest='safe', alerts=[], affected=[];

  for(const crop of region.crops) {
    // Per-region override takes priority; fall back to global default
    const regionCropDef = region.cropRisk && region.cropRisk[crop];
    const globalCropDef = CROP_RISKS[crop];
    const cd = regionCropDef || globalCropDef;
    if(!cd) continue;

    const crit   = cd.criticalMonths;
    const inWindow  = crit.includes(cm);
    const dtc       = daysUntilCritical(crit);
    const nearWindow = dtc>0 && dtc<=WATCH_DAYS;
    const frostDays  = mins.filter(t=>t<=cd.frostThreshold);
    const coldDays   = mins.filter(t=>t>cd.frostThreshold && t<=cd.watchThreshold);

    if(inWindow && frostDays.length) {
      highest='critical'; affected.push(crop);
      alerts.push({level:'critical',crop,
        message:`FROST: ${frostDays.length} day(s) â‰¤${cd.frostThreshold}Â°C (min:${Math.min(...frostDays)}Â°C) â€” ${crop} flowering at critical risk!`});
    } else if(inWindow && coldDays.length) {
      if(highest!=='critical') highest='risk'; affected.push(crop);
      alerts.push({level:'risk',crop,
        message:`Near-frost during flowering: ${coldDays.length} day(s) below ${cd.watchThreshold}Â°C â€” ${crop} at risk.`});
    } else if(nearWindow && (frostDays.length||coldDays.length)) {
      if(!['critical','risk'].includes(highest)) highest='watch';
      alerts.push({level:'watch',crop,
        message:`${dtc} days to ${crop} critical window. Cold temps in forecast (min:${Math.min(...mins)}Â°C).`});
    }
  }
  return {region, weather, risk_level:highest, alerts, affected_crops:[...new Set(affected)]};
}

// ============================================================
// WEATHER FETCH
// ============================================================
const WX = {0:'â˜€ï¸',1:'ğŸŒ¤',2:'â›…',3:'â˜ï¸',45:'ğŸŒ«',51:'ğŸŒ¦',53:'ğŸŒ¦',61:'ğŸŒ§',63:'ğŸŒ§',71:'ğŸŒ¨',73:'ğŸŒ¨',75:'â„ï¸',80:'ğŸŒ¦',81:'ğŸŒ§',95:'â›ˆ',99:'â›ˆ'};
const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

async function fetchWeather(region) {
  const url=`https://api.open-meteo.com/v1/forecast?latitude=${region.lat}&longitude=${region.lon}&current=temperature_2m,weathercode,windspeed_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum&timezone=auto&forecast_days=7`;
  const r=await fetch(url); if(!r.ok) throw new Error();
  const d=await r.json();
  return {
    current_temp:Math.round(d.current.temperature_2m),
    wind_kmh:Math.round(d.current.windspeed_10m),
    precip_mm:Math.round(d.current.precipitation*10)/10,
    daily_dates:d.daily.time,
    daily_max:d.daily.temperature_2m_max.map(t=>Math.round(t)),
    daily_min:d.daily.temperature_2m_min.map(t=>Math.round(t)),
    daily_codes:d.daily.weathercode,
    min_7d:Math.round(Math.min(...d.daily.temperature_2m_min)),
  };
}

// ============================================================
// RENDER CARD
// ============================================================
function renderCard(result) {
  const {region,weather,risk_level,alerts,affected_crops}=result;
  const riskLabels={safe:'safe',watch:'watch',risk:'risk',critical:'critical'};
  const cropTags=region.crops.map(c=>{
    const aff=affected_crops.includes(c);
    return `<span class="crop-tag${aff?' affected':''}">${CROP_RISKS[c]?.icon||''} ${c}</span>`;
  }).join('');
  const alertHtml=alerts.map(a=>`<div class="frost-warning">âš ï¸ ${a.message}</div>`).join('');
  const forecast=weather.daily_dates.slice(0,7).map((dt,i)=>{
    const mn=weather.daily_min[i], mx=weather.daily_max[i];
    const frost=mn<=0;
    const dn=DAYS[new Date(dt+'T12:00:00').getDay()];
    return `<div class="forecast-day${frost?' frost-day':''}">
      <div class="forecast-day-name">${dn}</div>
      <div class="forecast-icon">${WX[weather.daily_codes[i]]||'ğŸŒ¡'}</div>
      <div class="forecast-temp${frost?' cold':''}">${mx}Â°/${mn}Â°</div>
    </div>`;
  }).join('');
  return `<div class="region-card" data-crops="${region.crops.join(',')}" data-risk="${risk_level}">
    <div class="region-header">
      <div><div class="region-name">${region.flag} ${region.name}</div><div class="region-country">${region.country}</div></div>
      <span class="risk-badge ${risk_level}">${risk_level}</span>
    </div>
    <div class="region-body">
      <div class="weather-row">
        <div class="weather-stat"><div class="weather-stat-val">${weather.current_temp}Â°C</div><div class="weather-stat-label">Now</div></div>
        <div class="weather-stat"><div class="weather-stat-val" style="color:${weather.min_7d<=0?'var(--risk-critical)':'inherit'}">${weather.min_7d}Â°C</div><div class="weather-stat-label">Min 7d</div></div>
        <div class="weather-stat"><div class="weather-stat-val">${weather.wind_kmh}</div><div class="weather-stat-label">km/h</div></div>
        <div class="weather-stat"><div class="weather-stat-val">${weather.precip_mm}</div><div class="weather-stat-label">mm</div></div>
      </div>
      ${alertHtml}
      <div class="crops-row">${cropTags}</div>
      <div class="forecast-strip">${forecast}</div>
    </div>
  </div>`;
}

// ============================================================
// MAIN LOAD
// ============================================================
let allData=[];

async function loadAll() {
  document.getElementById('region-grid').innerHTML='<div class="loading-overlay"><div class="spinner"></div>Fetching live weather for '+REGIONS.length+' regions...</div>';
  document.getElementById('risk-table-body').innerHTML='<tr><td colspan="7" style="text-align:center;padding:20px;color:#aaa;font-family:monospace;font-size:0.8rem">Loading...</td></tr>';

  const season=getSeasonPhase();
  document.getElementById('season-status').textContent=season.status;
  document.getElementById('season-tip').textContent=season.tip;
  if(season.critical) document.getElementById('season-banner').style.background='linear-gradient(135deg,#7B1A12,#C0392B)';

  allData=await Promise.all(REGIONS.map(async r=>{
    try { const w=await fetchWeather(r); return assessRegion(r,w); }
    catch(e) { return {region:r,weather:null,risk_level:'watch',alerts:[{level:'watch',message:'Data unavailable'}],affected_crops:[]}; }
  }));

  renderAll(allData);
  document.getElementById('last-updated').textContent=`Updated: ${new Date().toLocaleTimeString('de-DE')}`;
}

function renderAll(data) {
  const counts={safe:0,watch:0,risk:0,critical:0};
  data.forEach(d=>counts[d.risk_level]++);
  ['safe','watch','risk','critical'].forEach(l=>document.getElementById('count-'+l).textContent=counts[l]);

  const crits=data.filter(d=>d.risk_level==='critical');
  const banner=document.getElementById('alert-banner');
  if(crits.length) {
    banner.style.display='block';
    banner.textContent=`ğŸš¨ CRITICAL FROST ALERTS: ${crits.map(d=>d.region.name).join(', ')} â€” Immediate attention required!`;
  } else banner.style.display='none';

  const order={critical:0,risk:1,watch:2,safe:3};
  const sorted=[...data].sort((a,b)=>order[a.risk_level]-order[b.risk_level]);

  document.getElementById('region-grid').innerHTML=sorted.map(d=>{
    if(!d.weather) return `<div class="region-card" data-crops="${d.region.crops.join(',')}" data-risk="${d.risk_level}"><div class="region-header"><div><div class="region-name">${d.region.flag} ${d.region.name}</div><div class="region-country">${d.region.country}</div></div><span class="risk-badge watch">N/A</span></div><div class="region-body" style="color:#aaa;font-size:0.8rem;padding:16px;">Weather data unavailable</div></div>`;
    return renderCard(d);
  }).join('');

  document.getElementById('risk-table-body').innerHTML=sorted.map(d=>{
    if(!d.weather) return '';
    const alert=d.alerts[0]?.message||'â€“';
    const crops=d.region.crops.map(c=>`${CROP_RISKS[c]?.icon} ${c}`).join(', ');
    return `<tr>
      <td><strong>${d.region.name}</strong></td>
      <td>${d.region.flag} ${d.region.country}</td>
      <td style="font-family:monospace">${d.weather.current_temp}Â°C</td>
      <td style="font-family:monospace;color:${d.weather.min_7d<=0?'var(--risk-critical)':'inherit'}">${d.weather.min_7d}Â°C</td>
      <td style="font-size:0.72rem">${crops}</td>
      <td><span class="dot ${d.risk_level}"></span>${d.risk_level.charAt(0).toUpperCase()+d.risk_level.slice(1)}</td>
      <td style="font-size:0.72rem;color:var(--mid)">${alert.length>70?alert.slice(0,70)+'â€¦':alert}</td>
    </tr>`;
  }).join('');
}

// ============================================================
// CROP FILTER
// ============================================================
function filterCrop(crop, btn) {
  document.querySelectorAll('.filter-bar .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.region-card').forEach(c=>{
    c.style.display=(crop==='all'||c.dataset.crops.includes(crop))?'block':'none';
  });
}

// ============================================================
// TAB SWITCH
// ============================================================
function switchTab(tab, btn) {
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab==='news') renderNews('all');
}

// ============================================================
// NEWS RENDER
// ============================================================
let currentNewsFilter='all';

function renderNews(filter) {
  currentNewsFilter=filter;
  const articles=filter==='all'?NEWS_ARTICLES:NEWS_ARTICLES.filter(a=>a.crop===filter||a.crop.includes(filter));
  if(!articles.length) {
    document.getElementById('news-grid').innerHTML='<div class="news-loading">No articles found for this crop.</div>';
    return;
  }
  document.getElementById('news-grid').innerHTML=articles.map(a=>`
    <div class="news-card" data-crop="${a.crop}">
      <div class="news-card-header">
        <span class="news-crop-tag">${CROP_RISKS[a.crop]?.icon||'ğŸŒ¿'} ${a.crop}</span>
        <span class="news-source">${a.source}</span>
      </div>
      <div class="news-body">
        <div class="news-title">${a.title}</div>
        <div class="news-summary">${a.summary}</div>
      </div>
      <div class="news-footer">
        <span class="news-date">ğŸ“ ${a.region} Â· ${a.date}</span>
        <a href="${a.url}" target="_blank" class="news-link">Read more â†’</a>
      </div>
    </div>`).join('');
}

function loadNews() {
  document.getElementById('news-grid').innerHTML='<div class="news-loading"><div class="spinner" style="display:inline-block;vertical-align:middle;margin-right:8px"></div>Refreshing news...</div>';
  setTimeout(()=>renderNews(currentNewsFilter), 800);
}

function filterNews(crop, btn) {
  document.querySelectorAll('.news-filter-bar .filter-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderNews(crop==='all'?'all':crop);
}

// ============================================================
// INIT
// ============================================================
loadAll();
setInterval(loadAll, 30*60*1000);
</script>
</body>
</html>
