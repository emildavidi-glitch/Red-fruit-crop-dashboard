<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Red Fruit Crop Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --red: #C0392B;
    --red-deep: #7B1A12;
    --red-light: #E74C3C;
    --cream: #FAF6F0;
    --warm-white: #FDF9F4;
    --charcoal: #1C1C1C;
    --mid: #5C5C5C;
    --light: #A8A8A8;
    --border: #E8DDD5;
    --risk-low: #27AE60;
    --risk-med: #F39C12;
    --risk-high: #E74C3C;
    --risk-critical: #7B1A12;
    --card-bg: #FFFFFF;
    --shadow: 0 2px 20px rgba(28,28,28,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    font-family: 'IBM Plex Sans', sans-serif;
    color: var(--charcoal);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--charcoal);
    color: var(--cream);
    padding: 0 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 70px;
    border-bottom: 3px solid var(--red);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .logo-icon {
    width: 36px;
    height: 36px;
    background: var(--red);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  .logo-text {
    font-family: 'Playfair Display', serif;
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: 0.01em;
  }

  .logo-sub {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--light);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-top: 1px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  #last-updated {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: var(--light);
  }

  .refresh-btn {
    background: var(--red);
    color: white;
    border: none;
    padding: 8px 18px;
    border-radius: 4px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: background 0.2s;
  }

  .refresh-btn:hover { background: var(--red-light); }

  /* ALERT BANNER */
  #alert-banner {
    display: none;
    background: var(--risk-critical);
    color: white;
    padding: 12px 40px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.8rem;
    letter-spacing: 0.05em;
    animation: pulse-bg 2s infinite;
  }

  @keyframes pulse-bg {
    0%, 100% { background: var(--risk-critical); }
    50% { background: var(--red-light); }
  }

  /* SEASON BANNER */
  #season-banner {
    background: linear-gradient(135deg, var(--red-deep) 0%, var(--red) 100%);
    color: white;
    padding: 14px 40px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .season-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    opacity: 0.8;
  }

  .season-status {
    font-family: 'Playfair Display', serif;
    font-size: 1.1rem;
    font-weight: 700;
  }

  .season-tip {
    font-size: 0.8rem;
    opacity: 0.85;
    max-width: 500px;
    text-align: right;
  }

  /* MAIN LAYOUT */
  main {
    padding: 32px 40px;
    max-width: 1400px;
    margin: 0 auto;
  }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 28px;
    flex-wrap: wrap;
    align-items: center;
  }

  .filter-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--mid);
    margin-right: 4px;
  }

  .filter-btn {
    padding: 7px 18px;
    border: 1.5px solid var(--border);
    background: white;
    border-radius: 20px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--mid);
    letter-spacing: 0.04em;
  }

  .filter-btn.active {
    background: var(--charcoal);
    color: white;
    border-color: var(--charcoal);
  }

  .filter-btn:hover:not(.active) {
    border-color: var(--red);
    color: var(--red);
  }

  /* SUMMARY CARDS ROW */
  .summary-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 32px;
  }

  .summary-card {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 20px 22px;
    box-shadow: var(--shadow);
    border-top: 3px solid transparent;
    transition: transform 0.2s;
  }

  .summary-card:hover { transform: translateY(-2px); }
  .summary-card.safe { border-top-color: var(--risk-low); }
  .summary-card.watch { border-top-color: var(--risk-med); }
  .summary-card.risk { border-top-color: var(--risk-high); }
  .summary-card.critical { border-top-color: var(--risk-critical); }

  .summary-num {
    font-family: 'Playfair Display', serif;
    font-size: 2.2rem;
    font-weight: 900;
    line-height: 1;
  }

  .summary-card.safe .summary-num { color: var(--risk-low); }
  .summary-card.watch .summary-num { color: var(--risk-med); }
  .summary-card.risk .summary-num { color: var(--risk-high); }
  .summary-card.critical .summary-num { color: var(--risk-critical); }

  .summary-desc {
    font-size: 0.78rem;
    color: var(--mid);
    margin-top: 6px;
    font-weight: 500;
  }

  /* SECTION TITLE */
  .section-title {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--charcoal);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* REGION GRID */
  .region-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .region-card {
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    border: 1px solid var(--border);
  }

  .region-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 30px rgba(28,28,28,0.14);
  }

  .region-header {
    padding: 16px 20px 14px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    border-bottom: 1px solid var(--border);
  }

  .region-name {
    font-family: 'Playfair Display', serif;
    font-size: 1.05rem;
    font-weight: 700;
  }

  .region-country {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    color: var(--light);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .risk-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.65rem;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: white;
  }

  .risk-badge.safe { background: var(--risk-low); }
  .risk-badge.watch { background: var(--risk-med); }
  .risk-badge.risk { background: var(--risk-high); }
  .risk-badge.critical { background: var(--risk-critical); }

  .region-body {
    padding: 16px 20px;
  }

  .weather-row {
    display: flex;
    gap: 16px;
    margin-bottom: 14px;
  }

  .weather-stat {
    flex: 1;
    text-align: center;
    padding: 10px;
    background: var(--cream);
    border-radius: 6px;
  }

  .weather-stat-val {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.1rem;
    font-weight: 500;
    color: var(--charcoal);
  }

  .weather-stat-label {
    font-size: 0.65rem;
    color: var(--light);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-top: 2px;
  }

  .frost-warning {
    background: #FFF3F3;
    border: 1px solid #FFCCCC;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 0.75rem;
    color: var(--risk-critical);
    font-weight: 500;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .crops-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 10px;
  }

  .crop-tag {
    padding: 3px 10px;
    border-radius: 10px;
    font-size: 0.68rem;
    font-family: 'IBM Plex Mono', monospace;
    background: var(--cream);
    border: 1px solid var(--border);
    color: var(--mid);
  }

  .crop-tag.affected {
    background: #FFF0EE;
    border-color: var(--red-light);
    color: var(--red);
  }

  .forecast-strip {
    display: flex;
    gap: 6px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    overflow-x: auto;
  }

  .forecast-day {
    flex: 1;
    min-width: 44px;
    text-align: center;
    padding: 6px 4px;
    border-radius: 5px;
    background: var(--cream);
  }

  .forecast-day.frost-day {
    background: #FFF0EE;
    border: 1px solid #FFCCCC;
  }

  .forecast-day-name {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6rem;
    color: var(--light);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .forecast-icon { font-size: 1rem; margin: 3px 0; }

  .forecast-temp {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.72rem;
    font-weight: 500;
  }

  .forecast-temp.cold { color: var(--risk-high); }

  .loading-overlay {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    color: var(--mid);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.05em;
  }

  .spinner {
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--red);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 12px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* RISK TABLE */
  .risk-table-wrap {
    background: var(--card-bg);
    border-radius: 10px;
    box-shadow: var(--shadow);
    overflow: hidden;
    border: 1px solid var(--border);
    margin-bottom: 40px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead {
    background: var(--charcoal);
    color: white;
  }

  th {
    padding: 14px 20px;
    text-align: left;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    font-weight: 500;
  }

  td {
    padding: 13px 20px;
    font-size: 0.82rem;
    border-bottom: 1px solid var(--border);
  }

  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--cream); }

  .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 8px;
  }

  .dot.safe { background: var(--risk-low); }
  .dot.watch { background: var(--risk-med); }
  .dot.risk { background: var(--risk-high); }
  .dot.critical { background: var(--risk-critical); }

  /* LEGEND */
  .legend {
    display: flex;
    gap: 24px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.78rem;
    color: var(--mid);
    font-family: 'IBM Plex Mono', monospace;
  }

  /* FOOTER */
  footer {
    background: var(--charcoal);
    color: var(--light);
    padding: 24px 40px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    letter-spacing: 0.05em;
  }

  /* RESPONSIVE */
  @media (max-width: 900px) {
    header, main, #season-banner, #alert-banner, footer { padding-left: 20px; padding-right: 20px; }
    .summary-row { grid-template-columns: repeat(2, 1fr); }
    .region-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üçí</div>
    <div>
      <div class="logo-text">Red Fruit Crop Monitor</div>
      <div class="logo-sub">Weather Risk Intelligence ¬∑ Germany</div>
    </div>
  </div>
  <div class="header-right">
    <span id="last-updated">Loading...</span>
    <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
  </div>
</header>

<div id="alert-banner"></div>

<div id="season-banner">
  <div>
    <div class="season-label">Current Season Phase</div>
    <div class="season-status" id="season-status">Calculating...</div>
  </div>
  <div class="season-tip" id="season-tip"></div>
</div>

<main>
  <!-- SUMMARY ROW -->
  <div class="summary-row">
    <div class="summary-card safe">
      <div class="summary-num" id="count-safe">‚Äì</div>
      <div class="summary-desc">‚úÖ Regions Safe</div>
    </div>
    <div class="summary-card watch">
      <div class="summary-num" id="count-watch">‚Äì</div>
      <div class="summary-desc">üëÅ Regions to Watch</div>
    </div>
    <div class="summary-card risk">
      <div class="summary-num" id="count-risk">‚Äì</div>
      <div class="summary-desc">‚ö†Ô∏è At Risk</div>
    </div>
    <div class="summary-card critical">
      <div class="summary-num" id="count-critical">‚Äì</div>
      <div class="summary-desc">üö® Critical Alert</div>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <span class="filter-label">Filter by crop:</span>
    <button class="filter-btn active" onclick="filterCrop('all', this)">All Crops</button>
    <button class="filter-btn" onclick="filterCrop('sour cherry', this)">üçí Sour Cherry</button>
    <button class="filter-btn" onclick="filterCrop('black currant', this)">ü´ê Black Currant</button>
    <button class="filter-btn" onclick="filterCrop('strawberry', this)">üçì Strawberry</button>
    <button class="filter-btn" onclick="filterCrop('raspberry', this)">ü´ê Raspberry</button>
    <button class="filter-btn" onclick="filterCrop('blueberry', this)">ü´ê Blueberry</button>
  </div>

  <!-- REGION CARDS -->
  <div class="section-title">Live Weather by Growing Region</div>

  <div id="region-grid" class="region-grid">
    <div class="loading-overlay"><div class="spinner"></div>Loading weather data from 10 regions...</div>
  </div>

  <!-- RISK TABLE -->
  <div class="section-title">Risk Summary Table</div>

  <div class="legend">
    <div class="legend-item"><span class="dot safe"></span> Safe ‚Äî no concern</div>
    <div class="legend-item"><span class="dot watch"></span> Watch ‚Äî monitor closely</div>
    <div class="legend-item"><span class="dot risk"></span> Risk ‚Äî possible crop impact</div>
    <div class="legend-item"><span class="dot critical"></span> Critical ‚Äî likely crop damage</div>
  </div>

  <div class="risk-table-wrap">
    <table>
      <thead>
        <tr>
          <th>Region</th>
          <th>Country</th>
          <th>Temp Now</th>
          <th>Min Forecast (7d)</th>
          <th>Key Crops</th>
          <th>Risk Level</th>
          <th>Alert</th>
        </tr>
      </thead>
      <tbody id="risk-table-body">
        <tr><td colspan="7" style="text-align:center;padding:30px;color:#aaa;font-family:'IBM Plex Mono',monospace;font-size:0.8rem;">Loading data...</td></tr>
      </tbody>
    </table>
  </div>

</main>

<footer>
  <div>Red Fruit Crop Monitor ¬∑ Weather data: Open-Meteo API (free, no key required)</div>
  <div>Built for processing factory operations ¬∑ Germany üá©üá™</div>
</footer>

<script>
// ============================================================
// CROP REGIONS CONFIGURATION
// Add or modify regions here as needed
// ============================================================
const REGIONS = [
  {
    id: 'masovia', name: 'Masovia', country: 'Poland üáµüá±',
    lat: 51.9, lon: 21.0,
    crops: ['sour cherry', 'black currant', 'raspberry'],
    notes: 'Largest sour cherry producing region in Europe'
  },
  {
    id: 'lubelskie', name: 'Lubelskie', country: 'Poland üáµüá±',
    lat: 51.2, lon: 22.5,
    crops: ['sour cherry', 'black currant', 'strawberry'],
    notes: 'Major black currant and cherry belt'
  },
  {
    id: 'podkarpacie', name: 'Podkarpacie', country: 'Poland üáµüá±',
    lat: 50.0, lon: 22.0,
    crops: ['sour cherry', 'raspberry', 'strawberry'],
    notes: 'Key raspberry and strawberry growing area'
  },
  {
    id: 'ukraine-west', name: 'Western Ukraine', country: 'Ukraine üá∫üá¶',
    lat: 49.5, lon: 25.5,
    crops: ['sour cherry', 'black currant', 'raspberry'],
    notes: 'Growing significance as EU supply source'
  },
  {
    id: 'serbia-sumadija', name: '≈†umadija', country: 'Serbia üá∑üá∏',
    lat: 44.0, lon: 20.9,
    crops: ['sour cherry', 'raspberry', 'strawberry'],
    notes: 'World leading raspberry region'
  },
  {
    id: 'moldova', name: 'Central Moldova', country: 'Moldova üá≤üá©',
    lat: 47.0, lon: 28.8,
    crops: ['sour cherry', 'black currant'],
    notes: 'Significant cherry concentrate source'
  },
  {
    id: 'moravia', name: 'South Moravia', country: 'Czechia üá®üáø',
    lat: 48.9, lon: 16.9,
    crops: ['sour cherry', 'black currant', 'raspberry'],
    notes: 'Traditional orchard region'
  },
  {
    id: 'hungary-bacs', name: 'B√°cs-Kiskun', country: 'Hungary üá≠üá∫',
    lat: 46.6, lon: 19.4,
    crops: ['sour cherry', 'raspberry', 'strawberry'],
    notes: 'Hungary\'s primary fruit belt'
  },
  {
    id: 'romania-olt', name: 'Olt Valley', country: 'Romania üá∑üá¥',
    lat: 44.5, lon: 24.5,
    crops: ['sour cherry', 'black currant', 'strawberry'],
    notes: 'Expanding fruit production region'
  },
  {
    id: 'germany-sachsen', name: 'Sachsen-Anhalt', country: 'Germany üá©üá™',
    lat: 51.8, lon: 11.7,
    crops: ['black currant', 'raspberry', 'strawberry'],
    notes: 'Domestic German production zone'
  },
  {
    id: 'turkey-aegean', name: 'Aegean Region', country: 'Turkey üáπüá∑',
    lat: 38.4, lon: 27.1,
    crops: ['sour cherry', 'black currant', 'raspberry', 'strawberry', 'blueberry'],
    notes: 'Major Turkish berry growing belt around Izmir and Manisa'
  },
  {
    id: 'turkey-marmara', name: 'Marmara Region', country: 'Turkey üáπüá∑',
    lat: 40.5, lon: 29.5,
    crops: ['sour cherry', 'raspberry', 'strawberry', 'blueberry'],
    notes: 'Key strawberry and cherry region near Bursa'
  },
  {
    id: 'canada-bc', name: 'British Columbia', country: 'Canada üá®üá¶',
    lat: 49.1, lon: -122.3,
    crops: ['blueberry', 'raspberry', 'strawberry'],
    notes: 'Largest blueberry producing region in Canada (Fraser Valley)'
  },
  {
    id: 'canada-ontario', name: 'Ontario', country: 'Canada üá®üá¶',
    lat: 44.3, lon: -79.5,
    crops: ['blueberry', 'raspberry', 'strawberry', 'black currant'],
    notes: 'Significant blueberry and soft fruit production'
  },
  {
    id: 'chile-ohiggins', name: "O'Higgins Region", country: 'Chile üá®üá±',
    lat: -34.5, lon: -71.0,
    crops: ['blueberry', 'raspberry', 'strawberry'],
    notes: 'Chile\'s top blueberry export region ‚Äî Southern Hemisphere counter-season supply'
  },
  {
    id: 'chile-biobio', name: 'Biob√≠o Region', country: 'Chile üá®üá±',
    lat: -37.5, lon: -72.5,
    crops: ['blueberry', 'raspberry'],
    notes: 'Major blueberry and raspberry growing belt in south-central Chile'
  }
];

// ============================================================
// CROP FROST RISK THRESHOLDS (¬∞C)
// Critical periods by month (1=Jan to 12=Dec)
// ============================================================
const CROP_RISKS = {
  'sour cherry': {
    criticalMonths: [4, 5],  // April, May = flowering
    frostThreshold: -1,
    watchThreshold: 2,
    icon: 'üçí'
  },
  'black currant': {
    criticalMonths: [4, 5],
    frostThreshold: -1,
    watchThreshold: 2,
    icon: 'ü´ê'
  },
  'strawberry': {
    criticalMonths: [4, 5, 6],
    frostThreshold: -0.5,
    watchThreshold: 3,
    icon: 'üçì'
  },
  'raspberry': {
    criticalMonths: [4, 5, 6],
    frostThreshold: -1,
    watchThreshold: 3,
    icon: 'ü´ê'
  },
  'blueberry': {
    // Northern hemisphere: April‚ÄìJune flowering. Southern hemisphere (Chile): Oct‚ÄìDec.
    // We handle hemisphere in assessRisk() using lat sign.
    criticalMonths: [4, 5, 6],
    criticalMonthsSouth: [10, 11, 12],
    frostThreshold: -1,
    watchThreshold: 2,
    icon: 'ü´ê'
  }
};

// ============================================================
// SEASON LOGIC
// ============================================================
function getSeasonPhase() {
  const now = new Date();
  const month = now.getMonth() + 1;
  const day = now.getDate();

  if (month === 3 || (month === 4 && day < 15)) return {
    status: 'üå± Pre-flowering ‚Äî Bud Break (N. Hemisphere)',
    tip: 'Late frosts now can damage buds before flowering. Monitor minimums below +2¬∞C. Chile/Southern Hemisphere: summer harvest season in progress.',
    critical: false
  };
  if (month === 4 || (month === 5 && day < 20)) return {
    status: 'üå∏ CRITICAL: Flowering Season (N. Hemisphere)',
    tip: '‚ö†Ô∏è Frost below 0¬∞C during flowering can destroy 100% of the crop. Monitor continuously. Chile: late harvest / post-harvest season.',
    critical: true
  };
  if (month === 5 || month === 6) return {
    status: 'üçÉ Fruit Set ‚Äî Post Flowering (N. Hemisphere)',
    tip: 'Frost risk decreasing but still possible. Monitor until June 10. Chilean blueberry season ended ‚Äî focus shifts north.',
    critical: false
  };
  if (month >= 7 && month <= 9) return {
    status: 'üçí Harvest Season (N. Hemisphere)',
    tip: 'Focus on rain and hail risk during harvest. Frost not a concern in the north. Southern Hemisphere entering pre-flowering.',
    critical: false
  };
  if (month === 10 || month === 11 || month === 12) return {
    status: '‚ùÑÔ∏è Dormancy N. Hemisphere ¬∑ üå∏ Flowering S. Hemisphere (Chile)',
    tip: 'Northern crops dormant. Chilean blueberry & raspberry in critical flowering window ‚Äî monitor southern region temperatures.',
    critical: month === 10 || month === 11
  };
  return {
    status: '‚ùÑÔ∏è Dormancy / Off-Season',
    tip: 'Crops are dormant. Monitor for extreme cold that could damage perennial root systems.',
    critical: false
  };
}

// ============================================================
// WEATHER DATA FETCH (Open-Meteo ‚Äî free, no API key)
// ============================================================
async function fetchWeather(region) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${region.lat}&longitude=${region.lon}&current=temperature_2m,weathercode,windspeed_10m,precipitation&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_sum&timezone=auto&forecast_days=7`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error('API error');
  return resp.json();
}

// ============================================================
// RISK ASSESSMENT
// ============================================================
function assessRisk(region, weatherData) {
  const currentMonth = new Date().getMonth() + 1;
  const minTemps = weatherData.daily.temperature_2m_min;
  const currentTemp = weatherData.current.temperature_2m;

  let highestRisk = 'safe';
  let alerts = [];
  let affectedCrops = [];

  for (const crop of region.crops) {
    const cropDef = CROP_RISKS[crop];
    // Southern hemisphere crops (Chile) have reversed seasons
    const isSouth = region.lat < 0;
    const critMonths = (isSouth && cropDef.criticalMonthsSouth)
      ? cropDef.criticalMonthsSouth
      : cropDef.criticalMonths;
    const isCriticalMonth = critMonths.includes(currentMonth);
    const frostDays = minTemps.filter(t => t <= cropDef.frostThreshold);
    const watchDays = minTemps.filter(t => t <= cropDef.watchThreshold && t > cropDef.frostThreshold);

    if (isCriticalMonth && frostDays.length > 0) {
      highestRisk = 'critical';
      affectedCrops.push(crop);
      alerts.push(`FROST ALERT: ${frostDays.length} day(s) below ${cropDef.frostThreshold}¬∞C forecast ‚Äî ${crop} at critical risk!`);
    } else if (isCriticalMonth && watchDays.length > 0) {
      if (highestRisk !== 'critical') highestRisk = 'risk';
      affectedCrops.push(crop);
      alerts.push(`Near-frost temperatures forecast ‚Äî ${crop} flowering at risk.`);
    } else if (!isCriticalMonth && frostDays.length > 0) {
      if (highestRisk === 'safe') highestRisk = 'watch';
      alerts.push(`Cold temperatures forecast, outside critical window for ${crop}.`);
    }
  }

  return { riskLevel: highestRisk, alerts, affectedCrops };
}

// ============================================================
// RENDER HELPERS
// ============================================================
const WX_ICONS = {
  0: '‚òÄÔ∏è', 1: 'üå§', 2: '‚õÖ', 3: '‚òÅÔ∏è',
  45: 'üå´', 48: 'üå´',
  51: 'üå¶', 53: 'üå¶', 55: 'üåß',
  61: 'üåß', 63: 'üåß', 65: 'üåß',
  71: 'üå®', 73: 'üå®', 75: '‚ùÑÔ∏è',
  80: 'üå¶', 81: 'üåß', 82: '‚õà',
  95: '‚õà', 96: '‚õà', 99: '‚õà'
};

function wxIcon(code) { return WX_ICONS[code] || 'üå°'; }

const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

function buildForecastStrip(daily) {
  return daily.time.slice(0, 7).map((dateStr, i) => {
    const d = new Date(dateStr + 'T12:00:00');
    const minT = daily.temperature_2m_min[i];
    const maxT = daily.temperature_2m_max[i];
    const isFrost = minT <= 0;
    return `
      <div class="forecast-day${isFrost ? ' frost-day' : ''}">
        <div class="forecast-day-name">${DAYS[d.getDay()]}</div>
        <div class="forecast-icon">${wxIcon(daily.weathercode[i])}</div>
        <div class="forecast-temp${isFrost ? ' cold' : ''}">${Math.round(maxT)}¬∞/${Math.round(minT)}¬∞</div>
      </div>`;
  }).join('');
}

function renderCard(region, weather, risk) {
  const current = weather.current;
  const daily = weather.daily;
  const minNext7 = Math.min(...daily.temperature_2m_min);

  const cropTags = region.crops.map(c => {
    const affected = risk.affectedCrops.includes(c);
    return `<span class="crop-tag${affected ? ' affected' : ''}">${CROP_RISKS[c].icon} ${c}</span>`;
  }).join('');

  const alertHtml = risk.alerts.length > 0 ?
    risk.alerts.map(a => `<div class="frost-warning">‚ö†Ô∏è ${a}</div>`).join('') : '';

  return `
    <div class="region-card" data-crops="${region.crops.join(',')}" data-risk="${risk.riskLevel}">
      <div class="region-header">
        <div>
          <div class="region-name">${region.name}</div>
          <div class="region-country">${region.country}</div>
        </div>
        <span class="risk-badge ${risk.riskLevel}">${risk.riskLevel}</span>
      </div>
      <div class="region-body">
        <div class="weather-row">
          <div class="weather-stat">
            <div class="weather-stat-val">${Math.round(current.temperature_2m)}¬∞C</div>
            <div class="weather-stat-label">Now</div>
          </div>
          <div class="weather-stat">
            <div class="weather-stat-val">${Math.round(minNext7)}¬∞C</div>
            <div class="weather-stat-label">Min 7d</div>
          </div>
          <div class="weather-stat">
            <div class="weather-stat-val">${Math.round(current.windspeed_10m)} km/h</div>
            <div class="weather-stat-label">Wind</div>
          </div>
          <div class="weather-stat">
            <div class="weather-stat-val">${Math.round(current.precipitation)} mm</div>
            <div class="weather-stat-label">Rain</div>
          </div>
        </div>
        ${alertHtml}
        <div class="crops-row">${cropTags}</div>
        <div class="forecast-strip">${buildForecastStrip(daily)}</div>
      </div>
    </div>`;
}

// ============================================================
// MAIN LOAD FUNCTION
// ============================================================
let allData = [];

async function loadAll() {
  document.getElementById('region-grid').innerHTML =
    '<div class="loading-overlay"><div class="spinner"></div>Fetching live weather data for 10 regions...</div>';
  document.getElementById('risk-table-body').innerHTML =
    '<tr><td colspan="7" style="text-align:center;padding:30px;color:#aaa;font-family:\'IBM Plex Mono\',monospace;font-size:0.8rem;">Loading...</td></tr>';

  // Season
  const season = getSeasonPhase();
  document.getElementById('season-status').textContent = season.status;
  document.getElementById('season-tip').textContent = season.tip;
  if (season.critical) {
    document.getElementById('season-banner').style.background = 'linear-gradient(135deg, #7B1A12 0%, #C0392B 100%)';
  }

  // Fetch all regions in parallel
  allData = await Promise.all(REGIONS.map(async region => {
    try {
      const weather = await fetchWeather(region);
      const risk = assessRisk(region, weather);
      return { region, weather, risk, error: null };
    } catch (e) {
      return { region, weather: null, risk: { riskLevel: 'watch', alerts: ['Data unavailable'], affectedCrops: [] }, error: true };
    }
  }));

  renderAll(allData);

  // Update time
  document.getElementById('last-updated').textContent = `Updated: ${new Date().toLocaleTimeString('de-DE')}`;
}

function renderAll(data) {
  // Summary counts
  const counts = { safe: 0, watch: 0, risk: 0, critical: 0 };
  data.forEach(d => counts[d.risk.riskLevel]++);
  document.getElementById('count-safe').textContent = counts.safe;
  document.getElementById('count-watch').textContent = counts.watch;
  document.getElementById('count-risk').textContent = counts.risk;
  document.getElementById('count-critical').textContent = counts.critical;

  // Alert banner
  const criticals = data.filter(d => d.risk.riskLevel === 'critical');
  const banner = document.getElementById('alert-banner');
  if (criticals.length > 0) {
    banner.style.display = 'block';
    banner.textContent = `üö® CRITICAL FROST ALERTS: ${criticals.map(d => d.region.name).join(', ')} ‚Äî Immediate attention required!`;
  } else {
    banner.style.display = 'none';
  }

  // Cards
  document.getElementById('region-grid').innerHTML = data.map(d => {
    if (d.error || !d.weather) return `<div class="region-card"><div class="region-header"><div><div class="region-name">${d.region.name}</div><div class="region-country">${d.region.country}</div></div><span class="risk-badge watch">N/A</span></div><div class="region-body" style="color:#aaa;font-size:0.8rem;padding:20px;">Weather data unavailable</div></div>`;
    return renderCard(d.region, d.weather, d.risk);
  }).join('');

  // Table
  document.getElementById('risk-table-body').innerHTML = data.map(d => {
    if (!d.weather) return '';
    const minNext7 = Math.min(...d.weather.daily.temperature_2m_min);
    const alertText = d.risk.alerts.length > 0 ? d.risk.alerts[0] : '‚Äì';
    const cropIcons = d.region.crops.map(c => `${CROP_RISKS[c].icon} ${c}`).join(', ');
    return `<tr>
      <td><strong>${d.region.name}</strong></td>
      <td>${d.region.country}</td>
      <td><span style="font-family:'IBM Plex Mono',monospace">${Math.round(d.weather.current.temperature_2m)}¬∞C</span></td>
      <td><span style="font-family:'IBM Plex Mono',monospace;color:${minNext7 <= 0 ? 'var(--risk-critical)' : 'inherit'}">${Math.round(minNext7)}¬∞C</span></td>
      <td style="font-size:0.75rem">${cropIcons}</td>
      <td><span class="dot ${d.risk.riskLevel}"></span>${d.risk.riskLevel.charAt(0).toUpperCase() + d.risk.riskLevel.slice(1)}</td>
      <td style="font-size:0.75rem;color:var(--mid)">${alertText.length > 60 ? alertText.slice(0,60) + '‚Ä¶' : alertText}</td>
    </tr>`;
  }).join('');
}

// ============================================================
// CROP FILTER
// ============================================================
function filterCrop(crop, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  const cards = document.querySelectorAll('.region-card');
  cards.forEach(card => {
    if (crop === 'all') {
      card.style.display = 'block';
    } else {
      const crops = card.getAttribute('data-crops') || '';
      card.style.display = crops.includes(crop) ? 'block' : 'none';
    }
  });
}

// ============================================================
// INIT
// ============================================================
loadAll();
// Auto-refresh every 30 minutes
setInterval(loadAll, 30 * 60 * 1000);
</script>

</body>
</html>
